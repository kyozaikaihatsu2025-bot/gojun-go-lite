<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ë™ûÈ†Ü„ÅßGOÔºÅ | ÊïôÂ∏´„É≠„Ç∞„Ç§„É≥</title>
    <style>
      :root{
        --bg:#fff7ed; --panel:#fff1e6; --border:#ffd7b8;
        --text:#3b2a1a; --muted:#8a6a4a;
        --accent:#f97316; --accent-600:#ea580c;
      }
      *{ box-sizing:border-box; }
      html,body{ height:100%; margin:0; }
      body{
        display:flex; align-items:center; justify-content:center;
        font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP","Yu Gothic",Meiryo,sans-serif;
        background:linear-gradient(180deg,var(--bg),#fff);
        color:var(--text);
        padding:16px;
      }
      .card{
        width:min(520px, 100%);
        background:#fff;
        border:2px solid var(--border);
        border-radius:18px;
        padding:18px;
        box-shadow:0 10px 24px rgba(0,0,0,.08);
      }
      h1{ margin:0 0 10px; font-size:20px; }
      .muted{ color:var(--muted); font-size:14px; }
      .row{ margin-top:14px; }
      input{
        width:100%;
        font-size:18px;
        padding:14px 12px;
        border:2px solid var(--border);
        border-radius:14px;
        outline:none;
      }
      input:focus{ border-color:var(--accent); }
      button{
        width:100%;
        margin-top:12px;
        padding:14px 12px;
        font-size:18px;
        border:none;
        border-radius:14px;
        background:var(--accent);
        color:#fff;
        cursor:pointer;
      }
      button:disabled{ opacity:.6; cursor:not-allowed; }
      .msg{ margin-top:10px; font-size:15px; min-height:22px; }
      .top-actions{
        display:flex; gap:8px; margin-top:10px;
      }
      .ghost{
        background:#fff; color:var(--accent-600);
        border:2px solid var(--border);
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>ÊïôÂ∏´„É≠„Ç∞„Ç§„É≥</h1>
      <div class="muted">PINÔºàÊï∞Â≠ó4„Ç±„ÇøÔºâ„ÇíÂÖ•„Çå„Å¶„Å≠ üë©‚Äçüè´</div>

      <div class="row">
        <input id="pin" inputmode="numeric" autocomplete="one-time-code" placeholder="‰æãÔºö8478" />
        <button id="loginBtn">„É≠„Ç∞„Ç§„É≥</button>

        <div class="top-actions">
          <button id="backBtn" class="ghost" type="button">„ÇÇ„Å©„ÇãÔºà„Éà„ÉÉ„ÉóÔºâ</button>
        </div>

        <div id="msg" class="msg muted"></div>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);

      const msg = (t) => { $('msg').textContent = t || ''; };

      const setBusy = (b) => {
        $('loginBtn').disabled = b;
        $('pin').disabled = b;
      };

      const goTop = async () => {
        const base = await getBaseUrl();
        // doGet„ÅÆ„Éá„Éï„Ç©„É´„ÉàÔºàlogin„Å∏Ôºâ„Å´Êàª„Åô
        window.top.location.href = base;
      };

      const getBaseUrl = () => new Promise((resolve) => {
        const cached = sessionStorage.getItem('go_execBaseUrl');
        if (cached && cached.includes('/exec')) return resolve(cached);

        google.script.run
          .withSuccessHandler((baseUrl) => {
            const base = String(baseUrl || '').split('?')[0];
            if (base.includes('/exec')) sessionStorage.setItem('go_execBaseUrl', base);
            resolve(base);
          })
          .withFailureHandler(() => resolve(location.href.split('?')[0]))
          .getExecBaseUrl();
      });

      $('backBtn').addEventListener('click', goTop);

      $('loginBtn').addEventListener('click', async () => {
        setBusy(true);
        msg('Á¢∫Ë™ç‰∏≠‚Ä¶');

        const raw = $('pin').value || '';
        const pin = raw.replace(/[^\d]/g, '');

        google.script.run
          .withSuccessHandler(async (res) => {
            if (!res || !res.ok) {
              msg(res?.message || '„É≠„Ç∞„Ç§„É≥Â§±Êïó');
              setBusy(false);
              return;
            }
            const base = String(res.baseUrl || '').split('?')[0] || await getBaseUrl();

            sessionStorage.setItem('go_execBaseUrl', base);
            sessionStorage.setItem('go_teacherKey', res.adminKey);

            // admin=1 „Çí‰ªò„Åë„Å¶ teacher „ÇíÈñã„ÅèÔºà/exec „ÅÆ„Ç¢„Éâ„É¨„Çπ„Éê„ÉºË°®Á§∫„ÇíÂÆà„ÇãÔºâ
            window.top.location.href = `${base}?admin=1&k=${encodeURIComponent(res.adminKey)}`;
          })
          .withFailureHandler((e) => {
            msg(`„Ç®„É©„ÉºÔºö${e?.message || e}`);
            setBusy(false);
          })
          .teacherVerify(pin);
      });

      // Enter„Åß„ÇÇOK
      $('pin').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') $('loginBtn').click();
      });

      // /exec „ÇíÊè°„ÇãÔºàÁôΩÁîªÈù¢‰∫àÈò≤Ôºâ
      (async () => { await getBaseUrl(); })();
    </script>
  </body>
</html>
