<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>èªé †ã§GOï¼ | å…ˆç”Ÿãƒšãƒ¼ã‚¸</title>
    <style>
      :root{
        --bg:#fff7ed; --panel:#fff; --border:#ffd7b8;
        --text:#3b2a1a; --muted:#8a6a4a;
        --accent:#f97316; --accent-600:#ea580c; --accent-100:#ffedd5;
      }
      *{ box-sizing:border-box; }
      body{
        margin:0;
        font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP","Yu Gothic",Meiryo,sans-serif;
        background:linear-gradient(180deg,var(--bg),#fff);
        color:var(--text);
      }
      header{
        position:sticky; top:0; z-index:10;
        background:rgba(255,255,255,.92);
        backdrop-filter: blur(8px);
        border-bottom:2px solid var(--border);
        padding:12px 12px;
      }
      .bar{
        display:flex; gap:8px; align-items:center; justify-content:space-between;
        flex-wrap:wrap;
      }
      .title{
        display:flex; gap:10px; align-items:baseline;
      }
      .title h1{ margin:0; font-size:18px; }
      .title .muted{ color:var(--muted); font-size:12px; }
      .tabs{ display:flex; gap:8px; flex-wrap:wrap; }
      .tab{
        padding:10px 12px;
        border:2px solid var(--border);
        border-radius:14px;
        background:#fff;
        cursor:pointer;
        font-size:14px;
      }
      .tab.active{ background:var(--accent-100); border-color:var(--accent); }
      .btn{
        padding:10px 12px;
        border-radius:14px;
        border:none;
        background:var(--accent);
        color:#fff;
        cursor:pointer;
        font-size:14px;
      }
      .btn.ghost{
        background:#fff; color:var(--accent-600);
        border:2px solid var(--border);
      }
      main{ padding:12px; max-width:1200px; margin:0 auto; }
      .card{
        background:var(--panel);
        border:2px solid var(--border);
        border-radius:18px;
        padding:14px;
        box-shadow:0 10px 24px rgba(0,0,0,.06);
        margin-bottom:12px;
      }
      .grid{
        display:grid;
        grid-template-columns: 1fr;
        gap:12px;
      }
      @media (min-width: 920px){
        .grid.two{ grid-template-columns: 1fr 1fr; }
      }

      label{ display:block; font-size:13px; color:var(--muted); margin:8px 0 4px; }
      input, textarea, select{
        width:100%;
        font-size:16px;
        padding:10px 10px;
        border:2px solid var(--border);
        border-radius:14px;
        outline:none;
      }
      input:focus, textarea:focus{ border-color:var(--accent); }

      .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
      .row > *{ flex:1; min-width:140px; }

      table{
        width:100%;
        border-collapse:separate;
        border-spacing:0;
        overflow:hidden;
        border:2px solid var(--border);
        border-radius:14px;
        background:#fff;
      }
      th, td{
        padding:10px 8px;
        border-bottom:1px solid var(--border);
        font-size:14px;
        text-align:left;
        vertical-align:top;
      }
      th{ background:var(--accent-100); }
      tr:last-child td{ border-bottom:none; }
      .small{ font-size:12px; color:var(--muted); }
      .right{ text-align:right; }
      .click{ cursor:pointer; }
      .pill{
        display:inline-block;
        padding:4px 8px;
        border-radius:999px;
        border:1px solid var(--border);
        background:#fff;
        font-size:12px;
        color:var(--muted);
      }

      /* modal */
      .modal-back{
        position:fixed; inset:0;
        background:rgba(0,0,0,.35);
        display:none;
        align-items:center; justify-content:center;
        padding:16px;
        z-index:50;
      }
      .modal{
        width:min(920px, 100%);
        background:#fff;
        border:2px solid var(--border);
        border-radius:18px;
        padding:14px;
      }
      .modal h2{ margin:0 0 6px; font-size:18px; }
      .modal .actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:10px; }
      .danger{ background:#ef4444; }
    </style>
  </head>
  <body>
    <header>
      <div class="bar">
        <div class="title">
          <h1>å…ˆç”Ÿãƒšãƒ¼ã‚¸</h1>
          <div class="muted" id="status">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
        </div>

        <div class="tabs">
          <button class="tab active" data-tab="settings">è¨­å®š</button>
          <button class="tab" data-tab="dashboard">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
          <button class="tab" data-tab="students">ç”Ÿå¾’ç®¡ç†</button>
        </div>

        <div class="row" style="flex:0 0 auto; gap:8px;">
          <button class="btn ghost" id="refreshBtn">æ›´æ–°</button>
          <button class="btn ghost" id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
      </div>
    </header>

    <main>
      <!-- è¨­å®š -->
      <section id="tab-settings">
        <div class="grid two">
          <div class="card">
            <h2 style="margin:0 0 8px;">A. éŸ³å£°ã‚¹ãƒ”ãƒ¼ãƒ‰ï¼ˆTTS/éŸ³å£°ï¼‰</h2>
            <div class="row">
              <div>
                <label>é€šå¸¸ï¼ˆä¾‹ï¼š1.0ï¼‰</label>
                <input id="ttsNormal" type="number" step="0.1" />
              </div>
              <div>
                <label>ã‚†ã£ãã‚Šï¼ˆä¾‹ï¼š0.5ï¼‰</label>
                <input id="ttsSlow" type="number" step="0.1" />
              </div>
            </div>
            <div class="small">ç”Ÿå¾’ã”ã¨ã®ä¸Šæ›¸ãã¯ã€Œç”Ÿå¾’è©³ç´°ã€ã§ã§ãã¾ã™ã€‚</div>
          </div>

          <div class="card">
            <h2 style="margin:0 0 8px;">B. ãƒœã‚¹è§£æ”¾ã‚³ã‚¹ãƒˆï¼ˆunitåˆ¥ï¼‰</h2>
            <div id="bossCostBox"></div>
          </div>
        </div>

        <div class="grid two">
          <div class="card">
            <h2 style="margin:0 0 8px;">C. ã‚³ã‚¤ãƒ³ä»˜ä¸ãƒ«ãƒ¼ãƒ«ï¼ˆmodeåˆ¥ï¼‰</h2>
            <div class="small">miss0/miss1/miss2/else ã‚’æ•°å­—ã§ã€‚</div>
            <div id="coinRulesBox"></div>
          </div>

          <div class="card">
            <h2 style="margin:0 0 8px;">D. ã‚¹ã‚¿ãƒ³ãƒ—â˜…é–¾å€¤</h2>
            <div class="row">
              <div>
                <label>â˜…â˜†â˜† ã«ãªã‚‹å›æ•°</label>
                <input id="star1" type="number" step="1" />
              </div>
              <div>
                <label>â˜…â˜…â˜† ã«ãªã‚‹å›æ•°</label>
                <input id="star2" type="number" step="1" />
              </div>
              <div>
                <label>â˜…â˜…â˜… ã«ãªã‚‹å›æ•°</label>
                <input id="star3" type="number" step="1" />
              </div>
            </div>
          </div>
        </div>

        <div class="grid two">
          <div class="card">
            <h2 style="margin:0 0 8px;">â‘¡ å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ON/OFF</h2>
            <div class="row" style="gap:10px;">
              <label><input type="checkbox" id="toggleChallenge" /> ãƒãƒ£ãƒ¬ãƒ³ã‚¸ON</label>
              <label><input type="checkbox" id="toggleBoss" /> ãƒœã‚¹ON</label>
              <label><input type="checkbox" id="toggleStamp" /> ã‚¹ã‚¿ãƒ³ãƒ—ON</label>
            </div>
            <div class="small">æˆæ¥­ä¸­ã®äº‹æ•…é˜²æ­¢ã«åŠ¹ãã‚„ã¤ğŸ‘</div>
          </div>

          <div class="card">
            <h2 style="margin:0 0 8px;">â‘¢ ç›®æ¨™ï¼ˆunitåˆ¥ï¼‰</h2>
            <div id="goalsBox"></div>
            <div class="small">ä¾‹ï¼šunit1ã¯ã‚³ã‚¤ãƒ³20ã§åˆæ ¼ã€ãªã©</div>
          </div>
        </div>

        <div class="card">
          <h2 style="margin:0 0 8px;">â‘£ ãƒ‡ãƒãƒƒã‚°/é‹ç”¨</h2>
          <div class="row" style="gap:8px; align-items:flex-start;">
            <button class="btn" id="saveSettingsBtn">è¨­å®šã‚’ä¿å­˜</button>
            <button class="btn ghost" id="resetSettingsBtn">åˆæœŸå€¤ã«æˆ»ã™</button>
            <button class="btn ghost" id="exportBtn">JSONã‚’æ›¸ãå‡ºã—</button>
            <button class="btn ghost" id="importBtn">JSONã‚’èª­ã¿è¾¼ã¿</button>
          </div>
          <label>JSONï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—/å¾©å…ƒï¼‰</label>
          <textarea id="jsonArea" rows="6" placeholder="ã“ã“ã«JSONãŒå‡ºã¾ã™"></textarea>
          <div class="small">â€»èª­ã¿è¾¼ã¿ã¯ã€ŒJSONã‚’èª­ã¿è¾¼ã¿ã€ã‚’æŠ¼ã™ã‚ˆ</div>
        </div>
      </section>

      <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
      <section id="tab-dashboard" style="display:none;">
        <div class="card">
          <h2 style="margin:0 0 8px;">A. ä¸€è¦§ï¼ˆç”Ÿå¾’Ã—unitï¼‰</h2>
          <div class="small">ç”Ÿå¾’ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨å€‹åˆ¥è©³ç´°ãŒé–‹ãã¾ã™ã€‚</div>
          <div id="overviewTable"></div>
        </div>

        <div class="card">
          <h2 style="margin:0 0 8px;">C. ã‚¯ãƒ©ã‚¹ã®å‚¾å‘</h2>
          <div id="trendsBox"></div>
        </div>
      </section>

      <!-- ç”Ÿå¾’ç®¡ç† -->
      <section id="tab-students" style="display:none;">
        <div class="card">
          <h2 style="margin:0 0 8px;">â‘  ç”Ÿå¾’ã®ç®¡ç†</h2>
          <div class="small">enabled / PWãƒªã‚»ãƒƒãƒˆ / ãµã‚ŠãŒãªä¿®æ­£</div>
          <div id="studentsTable"></div>
        </div>
      </section>
    </main>

    <!-- modal -->
    <div class="modal-back" id="modalBack">
      <div class="modal">
        <h2 id="modalTitle">ç”Ÿå¾’è©³ç´°</h2>
        <div id="modalBody" class="small">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
        <div class="actions">
          <button class="btn ghost" id="modalClose">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);

      const state = {
        baseUrl: '',
        adminKey: '',
        settings: null,
        students: [],
      };

      const getParam = (k) => new URLSearchParams(location.search).get(k);

      const setStatus = (t) => { $('status').textContent = t; };

      const call = (fn, ...args) => new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)[fn](...args);
      });

      const ensureBaseUrl = async () => {
        const cached = sessionStorage.getItem('go_execBaseUrl');
        if (cached && cached.includes('/exec')) {
          state.baseUrl = cached;
          return cached;
        }
        const base = await call('getExecBaseUrl');
        const b = String(base || '').split('?')[0];
        sessionStorage.setItem('go_execBaseUrl', b);
        state.baseUrl = b;
        return b;
      };

      const ensureAdminKey = async () => {
        const k = getParam('k') || sessionStorage.getItem('go_teacherKey') || '';
        state.adminKey = k;

        if (!k) {
          await ensureBaseUrl();
          window.top.location.href = `${state.baseUrl}?page=teacher_login`;
          return false;
        }
        // ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã«ã‚‚ k ã‚’æƒãˆã‚‹ï¼ˆå¾©å¸°ã—ã‚„ã™ã„ï¼‰
        sessionStorage.setItem('go_teacherKey', k);
        return true;
      };

      const switchTab = (tab) => {
        document.querySelectorAll('.tab').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.tab === tab);
        });
        $('tab-settings').style.display = tab === 'settings' ? '' : 'none';
        $('tab-dashboard').style.display = tab === 'dashboard' ? '' : 'none';
        $('tab-students').style.display = tab === 'students' ? '' : 'none';
      };

      document.querySelectorAll('.tab').forEach(btn => {
        btn.addEventListener('click', () => switchTab(btn.dataset.tab));
      });

      const renderUnitInputs = (boxEl, mapObj, idPrefix) => {
        const units = Object.keys(mapObj || {}).sort((a,b)=>Number(a)-Number(b));
        boxEl.innerHTML = `
          <table>
            <thead><tr><th>unit</th><th class="right">å€¤</th></tr></thead>
            <tbody>
              ${units.map(u => `
                <tr>
                  <td>Unit ${u}</td>
                  <td class="right">
                    <input id="${idPrefix}${u}" type="number" step="1" value="${mapObj[u]}" />
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      };

      const renderCoinRules = (boxEl, rules) => {
        const modes = Object.keys(rules || {});
        boxEl.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>mode</th>
                <th class="right">miss0</th>
                <th class="right">miss1</th>
                <th class="right">miss2</th>
                <th class="right">else</th>
              </tr>
            </thead>
            <tbody>
              ${modes.map(m => `
                <tr>
                  <td><span class="pill">${m}</span></td>
                  <td class="right"><input id="cr_${m}_0" type="number" step="1" value="${rules[m].miss0}" /></td>
                  <td class="right"><input id="cr_${m}_1" type="number" step="1" value="${rules[m].miss1}" /></td>
                  <td class="right"><input id="cr_${m}_2" type="number" step="1" value="${rules[m].miss2}" /></td>
                  <td class="right"><input id="cr_${m}_e" type="number" step="1" value="${rules[m].else}" /></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      };

      const loadAll = async () => {
        setStatus('èª­ã¿è¾¼ã¿ä¸­â€¦');
        await ensureBaseUrl();
        const ok = await ensureAdminKey();
        if (!ok) return;

        try {
          const [settings, students, trends] = await Promise.all([
            call('teacherGetSettings', state.adminKey),
            call('teacherListStudents', state.adminKey),
            call('teacherGetClassTrends', state.adminKey),
          ]);

          state.settings = settings;
          state.students = students;

          setStatus('OK');

          // settingsç”»é¢ã¸åæ˜ 
          $('ttsNormal').value = settings.tts.normal;
          $('ttsSlow').value = settings.tts.slow;

          renderUnitInputs($('bossCostBox'), settings.bossCostByUnit, 'bossCost_u');
          renderUnitInputs($('goalsBox'), settings.goalsByUnit, 'goal_u');
          renderCoinRules($('coinRulesBox'), settings.coinRulesByMode);

          $('star1').value = settings.stampThresholds.star1;
          $('star2').value = settings.stampThresholds.star2;
          $('star3').value = settings.stampThresholds.star3;

          $('toggleChallenge').checked = !!settings.featureToggles.challenge;
          $('toggleBoss').checked = !!settings.featureToggles.boss;
          $('toggleStamp').checked = !!settings.featureToggles.stamp;

          // dashboard
          renderOverviewTable(students);
          renderTrends(trends);

          // studentsç®¡ç†
          renderStudentsManage(students);

        } catch (e) {
          setStatus(`ã‚¨ãƒ©ãƒ¼ï¼š${e?.message || e}`);
          // adminåˆ‡ã‚Œã®æ™‚ã¯ãƒ­ã‚°ã‚¤ãƒ³ã¸
          if (String(e?.message || e).includes('æœŸé™')) {
            sessionStorage.removeItem('go_teacherKey');
            window.top.location.href = `${state.baseUrl}?page=teacher_login`;
          }
        }
      };

      const collectSettingsFromUI = () => {
        const s = JSON.parse(JSON.stringify(state.settings || {}));

        s.tts.normal = Number($('ttsNormal').value);
        s.tts.slow = Number($('ttsSlow').value);

        // bossCostByUnit
        for (const u of Object.keys(s.bossCostByUnit || {})) {
          const el = document.getElementById(`bossCost_u${u}`);
          if (el) s.bossCostByUnit[u] = Number(el.value);
        }

        // goalsByUnit
        for (const u of Object.keys(s.goalsByUnit || {})) {
          const el = document.getElementById(`goal_u${u}`);
          if (el) s.goalsByUnit[u] = Number(el.value);
        }

        // coinRulesByMode
        for (const m of Object.keys(s.coinRulesByMode || {})) {
          const r = s.coinRulesByMode[m];
          r.miss0 = Number(document.getElementById(`cr_${m}_0`)?.value ?? r.miss0);
          r.miss1 = Number(document.getElementById(`cr_${m}_1`)?.value ?? r.miss1);
          r.miss2 = Number(document.getElementById(`cr_${m}_2`)?.value ?? r.miss2);
          r.else  = Number(document.getElementById(`cr_${m}_e`)?.value ?? r.else);
        }

        s.stampThresholds.star1 = Number($('star1').value);
        s.stampThresholds.star2 = Number($('star2').value);
        s.stampThresholds.star3 = Number($('star3').value);

        s.featureToggles.challenge = $('toggleChallenge').checked;
        s.featureToggles.boss = $('toggleBoss').checked;
        s.featureToggles.stamp = $('toggleStamp').checked;

        return s;
      };

      $('saveSettingsBtn').addEventListener('click', async () => {
        try {
          setStatus('ä¿å­˜ä¸­â€¦');
          const s = collectSettingsFromUI();
          const res = await call('teacherSaveSettings', state.adminKey, s);
          state.settings = res.settings;
          $('jsonArea').value = JSON.stringify(res.settings, null, 2);
          setStatus('ä¿å­˜OK ğŸ‘');
        } catch (e) {
          setStatus(`ä¿å­˜ã‚¨ãƒ©ãƒ¼ï¼š${e?.message || e}`);
        }
      });

      $('resetSettingsBtn').addEventListener('click', async () => {
        try {
          setStatus('åˆæœŸåŒ–ä¸­â€¦');
          const res = await call('teacherResetSettings', state.adminKey);
          state.settings = res.settings;
          $('jsonArea').value = JSON.stringify(res.settings, null, 2);
          setStatus('åˆæœŸå€¤ã«æˆ»ã—ãŸã‚ˆ');
          await loadAll();
        } catch (e) {
          setStatus(`åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ï¼š${e?.message || e}`);
        }
      });

      $('exportBtn').addEventListener('click', () => {
        $('jsonArea').value = JSON.stringify(state.settings || {}, null, 2);
        setStatus('JSONã‚’æ›¸ãå‡ºã—ãŸã‚ˆ');
      });

      $('importBtn').addEventListener('click', async () => {
        try {
          const text = $('jsonArea').value || '';
          const obj = JSON.parse(text);
          setStatus('èª­ã¿è¾¼ã¿ä¸­â€¦');
          const res = await call('teacherSaveSettings', state.adminKey, obj);
          state.settings = res.settings;
          setStatus('èª­ã¿è¾¼ã¿OK');
          await loadAll();
        } catch (e) {
          setStatus(`èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ï¼š${e?.message || e}`);
        }
      });

      $('refreshBtn').addEventListener('click', loadAll);

      $('logoutBtn').addEventListener('click', async () => {
        try { await call('teacherLogout', state.adminKey); } catch (e) {}
        sessionStorage.removeItem('go_teacherKey');
        await ensureBaseUrl();
        window.top.location.href = `${state.baseUrl}?page=teacher_login`;
      });

      // --- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º ---
      const renderOverviewTable = (students) => {
        // unitæ•°ã¯æœ€åˆã®ç”Ÿå¾’ã® coinsByUnit ã‹ã‚‰æ¨æ¸¬
        const units = students?.[0] ? Object.keys(students[0].coinsByUnit || {}).map(Number).sort((a,b)=>a-b) : [1,2,3,4,5,6,7,8];

        const html = `
          <table>
            <thead>
              <tr>
                <th>ç”Ÿå¾’</th>
                ${units.map(u => `<th class="right">U${u} coin</th>`).join('')}
                ${units.map(u => `<th class="right">U${u} unlock</th>`).join('')}
              </tr>
            </thead>
            <tbody>
              ${students.map(s => `
                <tr class="click" data-student="${s.studentId}">
                  <td>
                    <div><b>${escapeHtml(s.name || s.studentId)}</b></div>
                    <div class="small">${escapeHtml(s.kana || '')} ${s.enabled ? '' : 'ï¼ˆOFFï¼‰'}</div>
                  </td>
                  ${units.map(u => `<td class="right">${Number(s.coinsByUnit?.[u] || 0)}</td>`).join('')}
                  ${units.map(u => `<td class="right">${s.unlockByUnit?.[u] ? 'âœ…' : 'â€”'}</td>`).join('')}
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;

        $('overviewTable').innerHTML = html;

        $('overviewTable').querySelectorAll('tr[data-student]').forEach(tr => {
          tr.addEventListener('click', () => openStudentDetail(tr.dataset.student));
        });
      };

      const renderTrends = (tr) => {
        const units = Object.keys(tr.avgCoinsByUnit || {}).map(Number).sort((a,b)=>a-b);
        $('trendsBox').innerHTML = `
          <div class="grid two">
            <div class="card" style="margin:0;">
              <h3 style="margin:0 0 6px;">unitåˆ¥ å¹³å‡ã‚³ã‚¤ãƒ³</h3>
              <table>
                <thead><tr><th>unit</th><th class="right">å¹³å‡</th></tr></thead>
                <tbody>
                  ${units.map(u => `<tr><td>U${u}</td><td class="right">${tr.avgCoinsByUnit[u]}</td></tr>`).join('')}
                </tbody>
              </table>
            </div>
            <div class="card" style="margin:0;">
              <h3 style="margin:0 0 6px;">unitåˆ¥ å¹³å‡æ­£ç­”ç‡</h3>
              <table>
                <thead><tr><th>unit</th><th class="right">%</th></tr></thead>
                <tbody>
                  ${units.map(u => `<tr><td>U${u}</td><td class="right">${tr.avgAccuracyByUnit[u]}%</td></tr>`).join('')}
                </tbody>
              </table>
            </div>
          </div>

          <div class="card" style="margin-top:12px;">
            <h3 style="margin:0 0 6px;">ã¿ã‚“ãªãŒã¤ã¾ãšã„ã¦ã‚‹å•é¡Œ TOP10ï¼ˆç›´è¿‘30æ—¥ãƒ»ä¸æ­£è§£ï¼‰</h3>
            <table>
              <thead><tr><th>item_id</th><th class="right">ä¸æ­£è§£å›æ•°</th></tr></thead>
              <tbody>
                ${(tr.topWrongItems || []).map(x => `<tr><td>${escapeHtml(x.itemId)}</td><td class="right">${x.wrongCount}</td></tr>`).join('') || '<tr><td colspan="2">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>'}
              </tbody>
            </table>
          </div>
        `;
      };

      // --- ç”Ÿå¾’ç®¡ç† ---
      const renderStudentsManage = (students) => {
        $('studentsTable').innerHTML = `
          <table>
            <thead>
              <tr>
                <th>ç”Ÿå¾’</th>
                <th class="right">enabled</th>
                <th>PWãƒªã‚»ãƒƒãƒˆ</th>
                <th>ãµã‚ŠãŒãªä¿®æ­£</th>
                <th>ä¿å­˜</th>
              </tr>
            </thead>
            <tbody>
              ${students.map(s => `
                <tr data-student="${s.studentId}">
                  <td>
                    <div><b>${escapeHtml(s.name || s.studentId)}</b></div>
                    <div class="small">${escapeHtml(s.studentId)}</div>
                  </td>
                  <td class="right">
                    <input type="checkbox" class="en" ${s.enabled ? 'checked' : ''} />
                  </td>
                  <td>
                    <input class="pw" inputmode="numeric" placeholder="æ•°å­—4ã‚±ã‚¿" />
                  </td>
                  <td>
                    <input class="kana" placeholder="ä¾‹ï¼šã‚„ã¾ã  ãŸã‚ã†" value="${escapeAttr(s.kana || '')}" />
                  </td>
                  <td>
                    <button class="btn ghost saveBtn" type="button">ä¿å­˜</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;

        $('studentsTable').querySelectorAll('.saveBtn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const tr = e.target.closest('tr[data-student]');
            const studentId = tr.dataset.student;
            const enabled = tr.querySelector('.en').checked;
            const pwRaw = tr.querySelector('.pw').value || '';
            const kana = tr.querySelector('.kana').value || '';

            const patch = { studentId, enabled, full_name_kana: kana };
            if (pwRaw.trim()) patch.login_pass = pwRaw;

            try {
              setStatus('ä¿å­˜ä¸­â€¦');
              await call('teacherUpdateStudent', state.adminKey, patch);
              setStatus('ä¿å­˜OK');
              await loadAll();
            } catch (err) {
              setStatus(`ä¿å­˜ã‚¨ãƒ©ãƒ¼ï¼š${err?.message || err}`);
            }
          });
        });
      };

      // --- ç”Ÿå¾’è©³ç´°ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ ---
      const openStudentDetail = async (studentId) => {
        $('modalBack').style.display = 'flex';
        $('modalTitle').textContent = `ç”Ÿå¾’è©³ç´°ï¼š${studentId}`;
        $('modalBody').textContent = 'èª­ã¿è¾¼ã¿ä¸­â€¦';

        try {
          const detail = await call('teacherGetStudentDetail', state.adminKey, studentId);
          const s = state.settings || {};
          const base = s.tts || { normal: 1.0, slow: 0.5 };
          const ov = (s.ttsOverridesByStudentId && s.ttsOverridesByStudentId[studentId]) ? s.ttsOverridesByStudentId[studentId] : null;
          const cur = ov || base;

          const units = Object.keys(detail.byUnit || {}).map(Number).sort((a,b)=>a-b);

          $('modalBody').innerHTML = `
            <div class="card" style="margin:0 0 12px;">
              <h3 style="margin:0 0 6px;">éŸ³å£°ã‚¹ãƒ”ãƒ¼ãƒ‰ï¼ˆã“ã®å­ã ã‘ä¸Šæ›¸ãï¼‰</h3>
              <div class="row">
                <div>
                  <label>é€šå¸¸</label>
                  <input id="ovN" type="number" step="0.1" value="${cur.normal}">
                </div>
                <div>
                  <label>ã‚†ã£ãã‚Š</label>
                  <input id="ovS" type="number" step="0.1" value="${cur.slow}">
                </div>
                <div style="flex:0 0 180px; min-width:180px;">
                  <label>&nbsp;</label>
                  <button class="btn" id="saveOv">ä¸Šæ›¸ãã‚’ä¿å­˜</button>
                </div>
              </div>
              <div class="small">ä¸Šæ›¸ãã‚’ã‚„ã‚ãŸã„æ™‚ã¯ã€é€šå¸¸=1.0/ã‚†ã£ãã‚Š=0.5 ã«æˆ»ã—ã¦ä¿å­˜ã§OK</div>
            </div>

            <div class="card" style="margin:0 0 12px;">
              <h3 style="margin:0 0 6px;">unitåˆ¥</h3>
              <table>
                <thead>
                  <tr><th>unit</th><th class="right">å›æ•°</th><th class="right">æ­£è§£</th><th class="right">ä¸æ­£è§£</th><th class="right">æ­£ç­”ç‡</th></tr>
                </thead>
                <tbody>
                  ${units.map(u => {
                    const x = detail.byUnit[u];
                    const rate = x.attempts ? Math.round((x.correct / x.attempts) * 1000) / 10 : 0;
                    return `<tr>
                      <td>U${u}</td>
                      <td class="right">${x.attempts}</td>
                      <td class="right">${x.correct}</td>
                      <td class="right">${x.wrong}</td>
                      <td class="right">${rate}%</td>
                    </tr>`;
                  }).join('')}
                </tbody>
              </table>
            </div>

            <div class="grid two">
              <div class="card" style="margin:0;">
                <h3 style="margin:0 0 6px;">ãƒ¢ãƒ¼ãƒ‰åˆ¥ å›æ•°</h3>
                <table>
                  <thead><tr><th>mode</th><th class="right">å›æ•°</th></tr></thead>
                  <tbody>
                    ${Object.keys(detail.byMode || {}).sort().map(m => `
                      <tr><td><span class="pill">${escapeHtml(m)}</span></td><td class="right">${detail.byMode[m]}</td></tr>
                    `).join('') || '<tr><td colspan="2">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>'}
                  </tbody>
                </table>
              </div>

              <div class="card" style="margin:0;">
                <h3 style="margin:0 0 6px;">ã¤ã¾ãšãTOP10ï¼ˆç´¯è¨ˆãƒ»ä¸æ­£è§£ï¼‰</h3>
                <table>
                  <thead><tr><th>item_id</th><th class="right">ä¸æ­£è§£å›æ•°</th></tr></thead>
                  <tbody>
                    ${(detail.topWrongItems || []).map(x => `
                      <tr><td>${escapeHtml(x.itemId)}</td><td class="right">${x.wrongCount}</td></tr>
                    `).join('') || '<tr><td colspan="2">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>'}
                  </tbody>
                </table>
              </div>
            </div>
          `;

          $('saveOv').addEventListener('click', async () => {
            try {
              setStatus('ä¿å­˜ä¸­â€¦');
              const n = Number(document.getElementById('ovN').value);
              const sl = Number(document.getElementById('ovS').value);
              await call('teacherSaveStudentTtsOverride', state.adminKey, studentId, n, sl);
              setStatus('ä¿å­˜OK');
              await loadAll();
            } catch (e) {
              setStatus(`ä¿å­˜ã‚¨ãƒ©ãƒ¼ï¼š${e?.message || e}`);
            }
          });

        } catch (e) {
          $('modalBody').textContent = `ã‚¨ãƒ©ãƒ¼ï¼š${e?.message || e}`;
        }
      };

      $('modalClose').addEventListener('click', () => $('modalBack').style.display = 'none');
      $('modalBack').addEventListener('click', (e) => {
        if (e.target === $('modalBack')) $('modalBack').style.display = 'none';
      });

      const escapeHtml = (s) => String(s ?? '')
        .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
        .replaceAll('"','&quot;').replaceAll("'","&#39;");
      const escapeAttr = (s) => escapeHtml(s);

      // èµ·å‹•
      loadAll();
    </script>
  </body>
</html>
