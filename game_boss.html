<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>èªé †ã§GOï¼ - ãƒœã‚¹è¨ä¼</title>

    <style>
      :root{
        --bg:#0f172a;
        --panel:#020617;
        --border:#1e293b;
        --text:#e5e7eb;
        --muted:#9ca3af;
        --accent:#fb923c;
        --accent-100:#ffedd5;
        --hp-boss:#f97316;
        --hp-player:#22c55e;
      }
      *{ box-sizing:border-box; }
      html,body{ height:100%; margin:0; }
      body{
        margin:0;
        font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,
          "Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,sans-serif;
        color:var(--text);
        background:radial-gradient(circle at top,#111827 0,#020617 55%,#000 100%);
      }
      .frame{
        max-width:960px;
        margin:12px auto;
        padding:12px;
      }
      .card{
        background:linear-gradient(135deg,rgba(30,64,175,.9),rgba(8,47,73,.95));
        border-radius:18px;
        border:1px solid rgba(148,163,184,.6);
        padding:14px;
        box-shadow:0 18px 45px rgba(15,23,42,.8);
      }
      .top-bar{
        display:flex;
        justify-content:space-between;
        align-items:flex-start;
        gap:8px;
        margin-bottom:10px;
        flex-wrap:wrap;
      }
      h1{
        margin:0;
        font-size:1.3rem;
      }
      .subtitle{
        font-size:.85rem;
        color:var(--accent-100);
      }
      .home-btn{
        border-radius:999px;
        padding:6px 14px;
        border:1px solid rgba(148,163,184,.7);
        background:rgba(15,23,42,.8);
        font-size:.8rem;
        cursor:pointer;
        color:var(--text);
      }
      .home-btn:hover{
        background:rgba(15,23,42,1);
      }

      .boss-area{
        display:flex;
        gap:12px;
        align-items:center;
        margin-bottom:10px;
        flex-wrap:wrap;
      }

      /* ==== ãƒœã‚¹ï¼ˆCSSã‚¤ãƒ©ã‚¹ãƒˆï¼‰ ==== */
      .boss-figure{
        position:relative;
        width:220px;
        height:220px;
        border-radius:30px;
        background:radial-gradient(circle at 30% 20%,#f97316,#7c2d12 60%,#111827);
        display:flex;
        flex-direction:column;
        align-items:center;
        justify-content:center;
        box-shadow:0 0 35px rgba(248,113,113,.7);
        border:2px solid rgba(248,250,252,.5);
        padding:10px 8px;
        overflow:hidden;
      }
      .boss-face{
        position:relative;
        width:180px;
        height:150px;
        border-radius:40px;
        background:radial-gradient(circle at 30% 20%,#fed7aa,#fb923c 50%,#7c2d12 100%);
        box-shadow:0 10px 20px rgba(15,23,42,.7);
        transition:filter .2s;
      }
      .boss-horn{
        position:absolute;
        width:46px;
        height:46px;
        background:linear-gradient(135deg,#fde68a,#f97316);
        border-radius:60% 60% 10% 10%;
        top:-20px;
        box-shadow:0 4px 8px rgba(0,0,0,.5);
      }
      .boss-horn.left{ left:14px; transform:rotate(-15deg); }
      .boss-horn.right{ right:14px; transform:rotate(15deg); }

      .boss-eye{
        position:absolute;
        top:52px;
        width:32px;
        height:32px;
        border-radius:50%;
        background:#f9fafb;
        box-shadow:0 2px 4px rgba(15,23,42,.5);
        overflow:hidden;
      }
      .boss-eye.left{ left:46px; }
      .boss-eye.right{ right:46px; }
      .boss-pupil{
        position:absolute;
        width:14px;
        height:14px;
        border-radius:50%;
        background:#020617;
        top:10px;
        left:10px;
        transition:opacity .2s;
      }

      .boss-mouth{
        position:absolute;
        left:50%;
        transform:translateX(-50%);
        bottom:26px;
        width:90px;
        height:40px;
        border-radius:0 0 40px 40px;
        background:#020617;
        overflow:hidden;
        box-shadow:0 4px 10px rgba(0,0,0,.7);
      }
      .boss-tooth{
        position:absolute;
        width:18px;
        height:18px;
        background:#f9fafb;
        clip-path:polygon(50% 0,0 100%,100% 100%);
        top:-2px;
      }
      .boss-tooth.t1{ left:14px; }
      .boss-tooth.t2{ left:36px; }
      .boss-tooth.t3{ right:36px; }
      .boss-tooth.t4{ right:14px; }

      .boss-label{
        font-size:.9rem;
        margin-top:8px;
        font-weight:700;
        text-shadow:0 0 6px rgba(0,0,0,.7);
        color:#fffbeb;
      }

      /* ===== Unit2: ã‚¨ãƒ™ãƒ³ãƒˆãƒ¢ãƒ³ï¼ˆèŠ±ç«ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ï¼‰ã‚¹ã‚­ãƒ³ ===== */
      .boss-figure.skin-eventmon{
        border-radius:999px;
        background:
          radial-gradient(circle at 40% 25%, rgba(56,189,248,.55) 0%, rgba(30,41,59,.2) 35%, rgba(2,6,23,1) 80%),
          radial-gradient(circle at 15% 80%, rgba(251,146,60,.25) 0%, rgba(2,6,23,0) 55%),
          radial-gradient(circle at 85% 75%, rgba(168,85,247,.22) 0%, rgba(2,6,23,0) 60%),
          radial-gradient(circle at 50% 50%, #0b1224 0%, #020617 70%, #000 100%);
        box-shadow:0 0 38px rgba(56,189,248,.35);
        border:2px solid rgba(148,163,184,.55);
      }
      .boss-figure.skin-eventmon::before{
        content:'';
        position:absolute;
        top:-18px;
        left:50%;
        width:18px;
        height:18px;
        border-radius:50%;
        transform:translateX(-50%);
        background:radial-gradient(circle at 35% 35%, #fff 0%, #fbbf24 35%, #f97316 70%, rgba(249,115,22,0) 75%);
        box-shadow:
          0 0 0 6px rgba(251,191,36,.20),
          0 0 0 14px rgba(249,115,22,.14),
          -18px 14px 0 -8px rgba(56,189,248,.9),
          18px 14px 0 -8px rgba(168,85,247,.9),
          0 22px 0 -10px rgba(250,204,21,.95);
      }
      .boss-figure.skin-eventmon::after{
        content:'';
        position:absolute;
        inset:10px;
        border-radius:999px;
        pointer-events:none;
        background:
          radial-gradient(circle, rgba(251,146,60,.95) 0 2px, transparent 3px) 20px 30px/60px 60px,
          radial-gradient(circle, rgba(56,189,248,.95) 0 2px, transparent 3px) 10px 10px/70px 70px,
          radial-gradient(circle, rgba(168,85,247,.95) 0 2px, transparent 3px) 35px 50px/80px 80px,
          radial-gradient(circle, rgba(250,204,21,.95) 0 2px, transparent 3px) 0 0/55px 55px;
        opacity:.75;
      }
      .boss-figure.skin-eventmon .boss-face{
        width:155px;
        height:155px;
        border-radius:999px;
        background:
          radial-gradient(circle at 35% 25%, #e0f2fe 0%, #93c5fd 28%, #1e293b 70%, #0b1224 100%);
        box-shadow:0 12px 24px rgba(2,6,23,.75);
      }
      .boss-figure.skin-eventmon .boss-horn{ display:none; }
      .boss-figure.skin-eventmon .boss-eye{
        top:52px;
        width:34px;
        height:34px;
        background:#f9fafb;
        box-shadow:0 2px 4px rgba(2,6,23,.65);
      }
      .boss-figure.skin-eventmon .boss-eye.left{ left:36px; }
      .boss-figure.skin-eventmon .boss-eye.right{ right:36px; }
      .boss-figure.skin-eventmon .boss-pupil{
        width:12px;
        height:12px;
        top:11px;
        left:11px;
      }
      .boss-figure.skin-eventmon .boss-eye::after{
        content:'';
        position:absolute;
        top:6px;
        left:7px;
        width:8px;
        height:8px;
        border-radius:2px;
        background:rgba(255,255,255,.95);
        transform:rotate(25deg);
        box-shadow:0 0 10px rgba(255,255,255,.35);
      }
      .boss-figure.skin-eventmon .boss-mouth{
        bottom:26px;
        width:92px;
        height:34px;
        border-radius:0 0 40px 40px;
        background:linear-gradient(180deg,#111827,#020617);
      }
      .boss-figure.skin-eventmon .boss-tooth{ display:none; }
      .boss-figure.skin-eventmon .boss-label{ color:#e0f2fe; }

      /* ===== Unit3: ãƒ‡ã‚¤ãƒªãƒ¼ã‚¹ãƒ©ã‚¤ãƒ ï¼ˆé€æ˜ã‚¹ãƒ©ã‚¤ãƒ ï¼‹ç”Ÿæ´»ç”¨å“ã·ã‹ã·ã‹ï¼‰ ===== */
      .boss-figure.skin-dailyslime{
        border-radius:42px;
        background:
          radial-gradient(circle at 35% 25%, rgba(240,253,250,.65) 0%, rgba(94,234,212,.35) 30%, rgba(2,6,23,1) 78%),
          radial-gradient(circle at 20% 85%, rgba(56,189,248,.18) 0%, rgba(2,6,23,0) 55%),
          radial-gradient(circle at 85% 78%, rgba(34,211,238,.18) 0%, rgba(2,6,23,0) 60%);
        box-shadow:0 0 38px rgba(94,234,212,.25);
        border:2px solid rgba(167,243,208,.45);
      }
      .boss-figure.skin-dailyslime::before{
        content:'';
        position:absolute;
        inset:12px;
        border-radius:38px;
        pointer-events:none;
        background:
          radial-gradient(circle, rgba(240,253,250,.65) 0 2px, transparent 3px) 0 0/44px 44px,
          radial-gradient(circle, rgba(94,234,212,.45) 0 2px, transparent 3px) 18px 20px/52px 52px,
          radial-gradient(circle, rgba(56,189,248,.35) 0 2px, transparent 3px) 10px 30px/60px 60px;
        opacity:.65;
        filter:blur(.2px);
        animation:slime-bubbles 3.8s ease-in-out infinite alternate;
      }
      .boss-figure.skin-dailyslime::after{
        content:'ğŸª¥  ğŸ§¦  ğŸ¥›  ğŸ“±';
        position:absolute;
        left:50%;
        top:14px;
        transform:translateX(-50%);
        font-size:18px;
        letter-spacing:10px;
        opacity:.9;
        text-shadow:0 2px 10px rgba(0,0,0,.55);
        animation:slime-float 2.6s ease-in-out infinite alternate;
      }
      @keyframes slime-bubbles{
        0%{ transform:translateY(0); opacity:.55; }
        100%{ transform:translateY(-6px); opacity:.75; }
      }
      @keyframes slime-float{
        0%{ transform:translateX(-50%) translateY(0); }
        100%{ transform:translateX(-50%) translateY(8px); }
      }
      .boss-figure.skin-dailyslime .boss-face{
        width:170px;
        height:150px;
        border-radius:46px;
        background:
          radial-gradient(circle at 30% 20%, rgba(240,253,250,.9) 0%, rgba(94,234,212,.55) 38%, rgba(2,6,23,.65) 100%);
        box-shadow:0 12px 26px rgba(2,6,23,.7);
        border:1px solid rgba(167,243,208,.35);
      }
      .boss-figure.skin-dailyslime .boss-horn{ display:none; }
      .boss-figure.skin-dailyslime .boss-eye{
        top:54px;
        width:30px;
        height:30px;
        background:rgba(249,250,251,.92);
      }
      .boss-figure.skin-dailyslime .boss-mouth{
        bottom:28px;
        width:86px;
        height:32px;
        border-radius:0 0 40px 40px;
        background:rgba(2,6,23,.92);
      }
      .boss-figure.skin-dailyslime .boss-tooth{ display:none; }
      .boss-figure.skin-dailyslime .boss-label{ color:#ccfbf1; }

      /* ===== Unit4: ã²ã‚„ã‘ã‚­ãƒ³ã‚°ï¼ˆæ—¥ç„¼ã‘å²©ï¼‹ã‚µãƒ³ã‚°ãƒ©ã‚¹ï¼‹æµ®ãè¼ªã†ã§ï¼‹ç ‚ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼‰ ===== */
      .boss-figure.skin-hiyakeking{
        border-radius:26px;
        background:
          radial-gradient(circle at 35% 25%, rgba(251,191,36,.28) 0%, rgba(2,6,23,0) 55%),
          radial-gradient(circle at 50% 50%, #3b2f2a 0%, #2b1f1a 45%, #111827 100%);
        box-shadow:0 0 35px rgba(251,191,36,.18);
        border:2px solid rgba(252,211,77,.25);
      }
      .boss-figure.skin-hiyakeking::before{
        content:'';
        position:absolute;
        inset:10px;
        border-radius:22px;
        pointer-events:none;
        background:
          radial-gradient(circle, rgba(254,243,199,.42) 0 1.5px, transparent 2.5px) 10px 14px/28px 28px,
          radial-gradient(circle, rgba(251,191,36,.28) 0 1.5px, transparent 2.5px) 0 0/34px 34px,
          radial-gradient(circle, rgba(244,114,182,.10) 0 2px, transparent 3px) 18px 8px/44px 44px;
        opacity:.85;
      }
      .boss-figure.skin-hiyakeking::after{
        content:'';
        position:absolute;
        bottom:-6px;
        left:-10px;
        right:-10px;
        height:42px;
        border-radius:999px;
        background:
          radial-gradient(circle at 20% 30%, rgba(253,230,138,.65) 0%, rgba(253,230,138,0) 60%),
          radial-gradient(circle at 55% 20%, rgba(254,215,170,.45) 0%, rgba(254,215,170,0) 65%),
          radial-gradient(circle at 80% 40%, rgba(253,230,138,.55) 0%, rgba(253,230,138,0) 60%);
        filter:blur(.2px);
        opacity:.85;
        animation:sand-drift 2.8s ease-in-out infinite alternate;
      }
      @keyframes sand-drift{
        0%{ transform:translateY(0); opacity:.75; }
        100%{ transform:translateY(-5px); opacity:.95; }
      }
      .boss-figure.skin-hiyakeking .boss-face{
        width:175px;
        height:150px;
        border-radius:36px;
        background:
          radial-gradient(circle at 35% 25%, #92400e 0%, #78350f 35%, #2b1f1a 100%);
        box-shadow:0 12px 26px rgba(2,6,23,.75);
      }
      .boss-figure.skin-hiyakeking .boss-horn{ display:none; }
      .boss-figure.skin-hiyakeking .boss-face::before{
        content:'';
        position:absolute;
        top:46px;
        left:24px;
        right:24px;
        height:34px;
        border-radius:14px;
        background:linear-gradient(180deg, rgba(2,6,23,.92), rgba(2,6,23,.72));
        box-shadow:0 6px 14px rgba(0,0,0,.65);
        border:1px solid rgba(148,163,184,.25);
      }
      .boss-figure.skin-hiyakeking .boss-face::after{
        content:'';
        position:absolute;
        top:62px;
        left:50%;
        width:18px;
        height:6px;
        transform:translateX(-50%);
        border-radius:999px;
        background:rgba(148,163,184,.35);
      }
      .boss-figure.skin-hiyakeking .boss-eye,
      .boss-figure.skin-hiyakeking .boss-mouth,
      .boss-figure.skin-hiyakeking .boss-tooth{
        display:none;
      }
      .boss-figure.skin-hiyakeking .boss-face .float-arm{
        position:absolute;
        top:72px;
        width:58px;
        height:42px;
        border-radius:999px;
        background:radial-gradient(circle at 35% 35%, rgba(255,255,255,.85) 0%, rgba(255,255,255,.25) 22%, rgba(249,115,22,.75) 35%, rgba(249,115,22,.75) 100%);
        box-shadow:0 8px 16px rgba(2,6,23,.6);
        border:1px solid rgba(255,255,255,.22);
      }
      .boss-figure.skin-hiyakeking .boss-face .float-arm.left{ left:-26px; transform:rotate(-10deg); }
      .boss-figure.skin-hiyakeking .boss-face .float-arm.right{ right:-26px; transform:rotate(10deg); }
      .boss-figure.skin-hiyakeking .boss-figure-tail{
        position:absolute;
        right:-6px;
        bottom:18px;
        width:0;
        height:0;
        border-left:26px solid transparent;
        border-right:26px solid transparent;
        border-top:38px solid rgba(56,189,248,.85);
        transform:rotate(20deg);
        filter:drop-shadow(0 6px 10px rgba(0,0,0,.55));
      }
      .boss-figure.skin-hiyakeking .boss-figure-tail::after{
        content:'';
        position:absolute;
        left:-2px;
        top:-2px;
        width:4px;
        height:46px;
        background:rgba(226,232,240,.75);
        border-radius:999px;
        transform:translateX(0) rotate(-20deg);
      }
      .boss-figure.skin-hiyakeking .boss-label{ color:#fde68a; }

      /* ===== Unit5: ãƒˆãƒ©ãƒ™ãƒ«ã‚²ãƒ¼ãƒˆï¼ˆå…‰ã‚‹ã‚²ãƒ¼ãƒˆï¼‹æ¸¦ï¼‹ãƒªãƒ³ã‚°ï¼‹è¿‘æœªæ¥ï¼‰ ===== */
      .boss-figure.skin-travelgate{
        border-radius:28px;
        background:
          radial-gradient(circle at 50% 35%, rgba(56,189,248,.22) 0%, rgba(2,6,23,0) 55%),
          radial-gradient(circle at 50% 50%, #0b1224 0%, #020617 75%, #000 100%);
        box-shadow:0 0 40px rgba(56,189,248,.22);
        border:2px solid rgba(56,189,248,.25);
      }
      .boss-figure.skin-travelgate::before{
        content:'';
        position:absolute;
        inset:14px;
        border-radius:26px;
        pointer-events:none;
        background:
          radial-gradient(circle at 50% 50%, rgba(56,189,248,.22) 0%, rgba(56,189,248,0) 55%),
          conic-gradient(from 20deg, rgba(56,189,248,.0), rgba(56,189,248,.5), rgba(168,85,247,.35), rgba(56,189,248,.0));
        mask:radial-gradient(circle at 50% 50%, transparent 0 58%, #000 62% 100%);
        opacity:.95;
        animation:gate-spin 3.2s linear infinite;
      }
      .boss-figure.skin-travelgate::after{
        content:'ğŸ›‚   ğŸ§³   ğŸ«';
        position:absolute;
        left:50%;
        top:18px;
        transform:translateX(-50%);
        font-size:18px;
        letter-spacing:16px;
        opacity:.95;
        text-shadow:0 2px 10px rgba(0,0,0,.55);
        animation:gate-items 2.2s ease-in-out infinite alternate;
      }
      @keyframes gate-spin{
        0%{ transform:rotate(0deg); opacity:.8; }
        100%{ transform:rotate(360deg); opacity:.95; }
      }
      @keyframes gate-items{
        0%{ transform:translateX(-50%) translateY(0); }
        100%{ transform:translateX(-50%) translateY(10px); }
      }
      .boss-figure.skin-travelgate .boss-face{
        width:165px;
        height:165px;
        border-radius:999px;
        background:
          conic-gradient(from 0deg, rgba(56,189,248,.12), rgba(168,85,247,.20), rgba(56,189,248,.12)),
          radial-gradient(circle at 50% 50%, rgba(2,6,23,.0) 0 45%, rgba(2,6,23,.95) 62% 100%);
        box-shadow:0 12px 26px rgba(2,6,23,.8);
        border:1px solid rgba(56,189,248,.25);
        animation:portal-swirl 1.2s linear infinite;
      }
      @keyframes portal-swirl{
        0%{ filter:hue-rotate(0deg) brightness(1.0); }
        100%{ filter:hue-rotate(18deg) brightness(1.05); }
      }
      .boss-figure.skin-travelgate .boss-horn{ display:none; }
      .boss-figure.skin-travelgate .boss-mouth,
      .boss-figure.skin-travelgate .boss-tooth{
        display:none;
      }
      .boss-figure.skin-travelgate .boss-eye{
        top:70px;
        width:22px;
        height:22px;
        background:rgba(224,242,254,.92);
        box-shadow:0 2px 10px rgba(56,189,248,.25);
      }
      .boss-figure.skin-travelgate .boss-eye.left{ left:62px; }
      .boss-figure.skin-travelgate .boss-eye.right{ right:62px; }
      .boss-figure.skin-travelgate .boss-pupil{
        width:10px;
        height:10px;
        top:6px;
        left:6px;
      }
      .boss-figure.skin-travelgate .boss-label{ color:#bae6fd; }

      /* ãƒœã‚¹ã®ãƒ€ãƒ¡ãƒ¼ã‚¸æ¼”å‡º */
      .boss-face.hit{
        animation:boss-shake .7s ease,boss-flash .7s ease;
      }
      .boss-face.hit .boss-pupil{
        opacity:0;
      }
      .boss-face.hit::before,
      .boss-face.hit::after{
        content:'Ã—';
        position:absolute;
        top:55px;
        font-size:26px;
        font-weight:900;
        color:#111827;
        text-shadow:0 0 4px rgba(248,250,252,.8);
      }
      .boss-face.hit::before{ left:52px; }
      .boss-face.hit::after{ right:52px; }

      @keyframes boss-shake{
        0%{ transform:translateX(0); }
        20%{ transform:translateX(-6px); }
        40%{ transform:translateX(6px); }
        60%{ transform:translateX(-4px); }
        80%{ transform:translateX(4px); }
        100%{ transform:translateX(0); }
      }
      @keyframes boss-flash{
        0%{ filter:none; }
        50%{ filter:brightness(1.4) saturate(1.4); }
        100%{ filter:none; }
      }

      /* ãƒœã‚¹ã®ãµãã ã— */
      .boss-speech{
        position:absolute;
        top:6px;
        left:50%;
        transform:translateX(-50%);
        padding:4px 10px;
        border-radius:999px;
        background:rgba(15,23,42,.95);
        border:1px solid rgba(248,250,252,.7);
        font-size:.8rem;
        white-space:nowrap;
        display:none;
        z-index:3;
      }
      .boss-speech.show{
        display:inline-block;
      }

      /* ==== HP / è³ªå•ã‚¨ãƒªã‚¢ ==== */
      .hp-panel{
        flex:1;
        min-width:180px;
      }
      .hp-row{
        display:flex;
        align-items:center;
        gap:8px;
        margin-bottom:6px;
      }
      .hp-name{
        font-size:.78rem;
        min-width:70px;
      }
      .hp-bar{
        flex:1;
        height:10px;
        border-radius:999px;
        background:rgba(15,23,42,.7);
        overflow:hidden;
      }
      .hp-inner-boss{
        height:100%;
        background:linear-gradient(90deg,var(--hp-boss),#facc15);
        transition:width .2s ease-out;
      }
      .hp-inner-player{
        height:100%;
        background:linear-gradient(90deg,var(--hp-player),#4ade80);
        transition:width .2s ease-out;
      }
      .hp-inner-player.hp-hit{
        animation:hp-shake .3s ease;
      }
      @keyframes hp-shake{
        0%{ transform:translateX(0); }
        25%{ transform:translateX(-4px); }
        50%{ transform:translateX(4px); }
        75%{ transform:translateX(-2px); }
        100%{ transform:translateX(0); }
      }
      .hp-text{
        font-size:.78rem;
        min-width:60px;
        text-align:right;
      }

      .question-card{
        margin-top:8px;
        background:rgba(15,23,42,.85);
        border-radius:14px;
        padding:12px;
        border:1px solid rgba(51,65,85,.8);
      }
      .q-header{
        display:flex;
        justify-content:space-between;
        align-items:center;
        gap:8px;
        margin-bottom:6px;
        flex-wrap:wrap;
      }
      .q-title{
        font-size:1rem;
        font-weight:600;
      }
      .q-sub{
        font-size:.82rem;
        color:var(--muted);
      }
      .q-count{
        font-size:.82rem;
      }

      .prompt-jp{
        font-size:.95rem;
        margin-bottom:6px;
      }
      .answer-label{
        font-size:.8rem;
        color:var(--muted);
        margin-bottom:4px;
      }

      /* âœ…âœ…âœ… ã“ã“ãŒä»Šå›ã®æœ€å°ä¿®æ­£ï¼šæŠ˜ã‚Šè¿”ã—ç¦æ­¢ï¼‹æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« âœ…âœ…âœ… */
      .answer-area,
      .word-bank{
        min-height:72px;
        padding:12px;
        border-radius:16px;
        border:1px dashed rgba(55,65,81,.9);
        background:rgba(15,23,42,.9);
        display:flex;

        /* â˜…å¤‰æ›´ï¼ˆwrap â†’ nowrapï¼‰ */
        flex-wrap:nowrap;

        /* â˜…è¿½åŠ ï¼šã¯ã¿å‡ºã—ãŸã‚‰æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
        overflow-x:auto;
        overflow-y:hidden;
        -webkit-overflow-scrolling:touch;

        gap:10px;
        margin-bottom:10px;

        /* â˜…è¿½åŠ ï¼šç¸¦æ–¹å‘ã®è¦‹ãŸç›®ã‚’å®‰å®šã•ã›ã‚‹ */
        align-items:center;
      }

      .slot{
        min-width:120px;
        min-height:52px;
        padding:10px 14px;
        border-radius:999px;
        border:2px dashed rgba(148,163,184,.8);
        font-size:1.05rem;
        display:flex;
        align-items:center;
        justify-content:center;
        color:var(--muted);
        background:rgba(15,23,42,.9);
        touch-action:none;

        /* â˜…è¿½åŠ ï¼šæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã«ç¸®ã¾ãªã„ */
        flex:0 0 auto;
        white-space:nowrap;
      }
      .slot.filled{
        border-style:solid;
        color:#e5e7eb;
      }

      .word-chip{
        padding:10px 18px;
        border-radius:999px;
        background:rgba(30,64,175,.95);
        border:2px solid rgba(129,140,248,.9);
        font-size:1.05rem;
        cursor:pointer;
        color:#e5e7eb;
        user-select:none;
        min-height:52px;
        display:flex;
        align-items:center;
        justify-content:center;
        touch-action:none;

        /* â˜…è¿½åŠ ï¼šæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã«ç¸®ã¾ãªã„ */
        flex:0 0 auto;
        white-space:nowrap;
      }
      .word-chip:active{
        transform:scale(.96);
      }

      .btn-row{
        display:flex;
        justify-content:space-between;
        align-items:center;
        gap:8px;
        flex-wrap:wrap;
        margin-top:4px;
      }
      .btn-main{
        padding:8px 18px;
        border-radius:999px;
        border:none;
        cursor:pointer;
        background:linear-gradient(135deg,#f97316,#ea580c);
        font-size:.95rem;
        font-weight:700;
        color:#111827;
      }
      .btn-main:hover{
        filter:brightness(1.05);
      }
      .btn-sub{
        padding:6px 14px;
        border-radius:999px;
        border:1px solid rgba(148,163,184,.7);
        background:rgba(15,23,42,.8);
        font-size:.85rem;
        cursor:pointer;
        color:var(--text);
      }
      .btn-sub:hover{
        background:rgba(15,23,42,1);
      }

      /* â˜… disabled è¦‹ãŸç›®ï¼ˆæœ€ä½é™ï¼‰ */
      .btn-main:disabled,
      .btn-sub:disabled{
        opacity:.55;
        cursor:not-allowed;
        filter:grayscale(.15);
      }

      .status-msg{
        font-size:.9rem;
        margin-top:6px;
      }
      .status-ok{
        color:#bbf7d0;
      }
      .status-ng{
        color:#fecaca;
      }

      .result-banner{
        margin-top:10px;
        padding:10px;
        border-radius:12px;
        text-align:center;
        font-size:.95rem;
      }
      .result-win{
        background:linear-gradient(135deg,#22c55e,#bef264);
        color:#052e16;
      }
      .result-lose{
        background:linear-gradient(135deg,#f97316,#fca5a5);
        color:#111827;
      }
      .result-buttons{
        margin-top:6px;
        display:flex;
        justify-content:center;
        gap:8px;
        flex-wrap:wrap;
      }

      .screen-flash{
        position:fixed;
        inset:0;
        background:rgba(248,113,113,.3);
        pointer-events:none;
        opacity:0;
        transition:opacity .2s;
        z-index:99;
      }
      .screen-flash.show{
        opacity:1;
      }

      /* ========== ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« ========== */
      .modal-backdrop{
        position:fixed;
        inset:0;
        background:rgba(15,23,42,.75);
        display:none;
        align-items:center;
        justify-content:center;
        z-index:120;
      }
      .modal-content{
        width:90%;
        max-width:360px;
        background:#020617;
        border-radius:16px;
        padding:16px;
        border:1px solid rgba(148,163,184,.8);
        box-shadow:0 20px 50px rgba(0,0,0,.7);
      }
      .modal-title{
        font-size:1rem;
        font-weight:700;
        margin-bottom:6px;
      }
      .modal-text{
        font-size:.85rem;
        color:var(--muted);
        margin-bottom:10px;
      }
      .modal-buttons{
        display:flex;
        flex-direction:column;
        gap:8px;
        margin-bottom:6px;
      }
      .modal-btn{
        width:100%;
        border-radius:999px;
        border:none;
        padding:10px 14px;
        font-size:.9rem;
        cursor:pointer;
      }
      .modal-btn.primary{
        background:linear-gradient(135deg,#f97316,#ea580c);
        color:#111827;
        font-weight:700;
      }
      .modal-btn.danger{
        background:rgba(248,113,113,.18);
        color:#fecaca;
        border:1px solid rgba(254,202,202,.8);
      }
      .modal-btn.ghost{
        background:transparent;
        color:#e5e7eb;
        border:1px solid rgba(148,163,184,.7);
      }
      .modal-btn:active{
        transform:scale(.98);
      }
    </style>
  </head>
  <body>
    <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¢«ãƒ€ãƒ¡ã®èµ¤ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ -->
    <div id="screenFlash" class="screen-flash"></div>

    <div class="frame">
      <div class="card">
        <div class="top-bar">
          <div>
            <h1>ãƒœã‚¹è¨ä¼ãƒãƒˆãƒ« âš”</h1>
            <div class="subtitle"></div>
          </div>
          <button class="home-btn" id="homeBtn">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ã‚‚ã©ã‚‹</button>
        </div>

        <div id="needMore" style="display:none; font-size:.9rem; color:#fee2e2; margin-top:4px;">
          ã¾ã ãƒœã‚¹ã«æŒ‘æˆ¦ã™ã‚‹ã«ã¯å•é¡ŒãŒè¶³ã‚Šãªã„ã¿ãŸã„â€¦  
          ã¾ãšã¯ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ã‚„ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ã§ã€ã„ã‚ã„ã‚ãªæ–‡ã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã‚ˆã†ï¼
        </div>

        <div class="boss-area" id="bossArea" style="display:none;">
          <div class="boss-figure">
            <div id="bossSpeech" class="boss-speech"></div>
            <div class="boss-face">
              <div class="boss-horn left"></div>
              <div class="boss-horn right"></div>

              <!-- Unit4 ã²ã‚„ã‘ã‚­ãƒ³ã‚°ç”¨ï¼ˆæ™®æ®µã¯CSSã§è¦‹ãˆãªã„ï¼‰ -->
              <div class="float-arm left"></div>
              <div class="float-arm right"></div>

              <div class="boss-eye left">
                <div class="boss-pupil"></div>
              </div>
              <div class="boss-eye right">
                <div class="boss-pupil"></div>
              </div>
              <div class="boss-mouth">
                <div class="boss-tooth t1"></div>
                <div class="boss-tooth t2"></div>
                <div class="boss-tooth t3"></div>
                <div class="boss-tooth t4"></div>
              </div>
            </div>

            <!-- Unit4 ã²ã‚„ã‘ã‚­ãƒ³ã‚°ç”¨ï¼ˆæ™®æ®µã¯CSSã§è¦‹ãˆãªã„ï¼‰ -->
            <div class="boss-figure-tail"></div>

            <div id="bossLabel" class="boss-label">ãƒŠãƒã‚¨ã‚¤ã‚¨ãƒ¼ãƒ«</div>
          </div>

          <div class="hp-panel">
            <div class="hp-row">
              <div class="hp-name">ãƒœã‚¹ HP</div>
              <div class="hp-bar">
                <div id="bossHpInner" class="hp-inner-boss"></div>
              </div>
              <div id="bossHpText" class="hp-text"></div>
            </div>
            <div class="hp-row">
              <div class="hp-name">ã‚­ãƒŸã® HP</div>
              <div class="hp-bar">
                <div id="playerHpInner" class="hp-inner-player"></div>
              </div>
              <div id="playerHpText" class="hp-text"></div>
            </div>
          </div>
        </div>

        <div id="questionCard" class="question-card" style="display:none;">
          <div class="q-header">
            <div>
              <div class="q-title">è‹±èªã®ã“ã¨ã°ã‚’ ãªã‚‰ã¹ã‹ãˆã‚ˆã†</div>
              <div class="q-sub"></div>
            </div>
            <div id="qCount" class="q-count"></div>
          </div>

          <div id="promptJp" class="prompt-jp"></div>

          <div class="answer-label">ãªã‚‰ã¹ãŸè‹±èª</div>
          <div id="answerArea" class="answer-area"></div>

          <div class="answer-label">ã¤ã‹ãˆã‚‹ã“ã¨ã°</div>
          <div id="wordBank" class="word-bank"></div>

          <div class="btn-row">
            <div>
              <button id="checkBtn" class="btn-main">ã“ãŸãˆã‚’ãƒã‚§ãƒƒã‚¯</button>
              <button id="resetBtn" class="btn-sub">ã‚„ã‚ŠãªãŠã™</button>
            </div>
          </div>
          <div id="statusMsg" class="status-msg"></div>
        </div>

        <div id="resultBanner" class="result-banner" style="display:none;"></div>
      </div>
    </div>

    <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ã‚‚ã©ã‚‹å‰ã®ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="exitModal" class="modal-backdrop">
      <div class="modal-content">
        <div class="modal-title">ã‚²ãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã©ã†ã™ã‚‹ï¼Ÿ</div>
        <p class="modal-text">
          ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ã‚‚ã©ã‚‹å‰ã«ã€ãƒ‡ãƒ¼ã‚¿ã®ã‚ã¤ã‹ã„ã‚’ãˆã‚‰ã‚“ã§ã­ã€‚
        </p>
        <div class="modal-buttons">
          <button id="resetGameBtn" class="modal-btn danger">
            ã‚²ãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
          </button>
          <button id="saveGameBtn" class="modal-btn primary">
            ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹
          </button>
        </div>
        <button id="cancelExitBtn" class="modal-btn ghost">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
      </div>
    </div>

    <script>
      // â˜… EXEC_BASE æ–¹å¼
      const EXEC_BASE = (() => {
        const url  = '<?= ScriptApp.getService().getUrl() ?>' || '';
        const base = url.split('?')[0];
        return base || 'https://script.google.com/macros/s/AKfycbxTrGkbntRAFg77NtbM3AsDrGx3hLGG9g3Wxd3ozjwcX0Xux6xuPF36KAFNZ8yBYu_V/exec';
      })();

      const TOKEN = '<?= token ?>';
      const UNIT  = '<?= typeof unit !== "undefined" ? unit : "" ?>';

      const NEXT_DELAY_MS = 260;
      const PREFETCH_FALLBACK_START_MS = 900;

      const SAVE_KEY = TOKEN
        ? `go_boss_state_${TOKEN}_${UNIT || 'all'}`
        : null;

      const buildMenuUrl = (token, unit) => {
        let url = EXEC_BASE + '?page=review_menu&t=' + encodeURIComponent(token);
        if (unit) url += '&unit=' + encodeURIComponent(unit);
        return url;
      };

      function goToMenu(){
        const url = buildMenuUrl(TOKEN, UNIT || '');
        try{
          window.top.location.href = url;
        }catch(e){
          window.location.href = url;
        }
      }
      window.goToMenu = goToMenu;

      const homeBtn    = document.getElementById('homeBtn');
      const needMoreEl = document.getElementById('needMore');
      const bossArea   = document.getElementById('bossArea');

      const bossHpInner   = document.getElementById('bossHpInner');
      const playerHpInner = document.getElementById('playerHpInner');
      const bossHpText    = document.getElementById('bossHpText');
      const playerHpText  = document.getElementById('playerHpText');

      const questionCard = document.getElementById('questionCard');
      const qCountEl     = document.getElementById('qCount');
      const promptJpEl   = document.getElementById('promptJp');
      const answerArea   = document.getElementById('answerArea');
      const wordBank     = document.getElementById('wordBank');
      const checkBtn     = document.getElementById('checkBtn');
      const resetBtn     = document.getElementById('resetBtn');
      const statusMsg    = document.getElementById('statusMsg');
      const resultBanner = document.getElementById('resultBanner');

      const bossFace     = document.querySelector('.boss-face');
      const bossSpeech   = document.getElementById('bossSpeech');
      const screenFlash  = document.getElementById('screenFlash');

      const exitModal      = document.getElementById('exitModal');
      const resetGameBtn   = document.getElementById('resetGameBtn');
      const saveGameBtn    = document.getElementById('saveGameBtn');
      const cancelExitBtn  = document.getElementById('cancelExitBtn');

      function applyBossSkin(){
        const fig = document.querySelector('.boss-figure');
        const label = document.getElementById('bossLabel');
        const sub = document.querySelector('.subtitle');

        if (!fig || !label) return;

        fig.classList.remove('skin-eventmon','skin-dailyslime','skin-hiyakeking','skin-travelgate');

        const u = String(UNIT);

        if (u === '2'){
          fig.classList.add('skin-eventmon');
          label.textContent = 'ã‚¨ãƒ™ãƒ³ãƒˆãƒ¢ãƒ³';
          if (sub) sub.textContent = 'Unit2 ãƒœã‚¹ï¼šã‚¨ãƒ™ãƒ³ãƒˆãƒ¢ãƒ³ï¼ˆèŠ±ç«ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ï¼‰';
        }else if (u === '3'){
          fig.classList.add('skin-dailyslime');
          label.textContent = 'ãƒ‡ã‚¤ãƒªãƒ¼ã‚¹ãƒ©ã‚¤ãƒ ';
          if (sub) sub.textContent = 'Unit3 ãƒœã‚¹ï¼šãƒ‡ã‚¤ãƒªãƒ¼ã‚¹ãƒ©ã‚¤ãƒ ï¼ˆç”Ÿæ´»ç”¨å“ã‚¹ãƒ©ã‚¤ãƒ ï¼‰';
        }else if (u === '4'){
          fig.classList.add('skin-hiyakeking');
          label.textContent = 'ã²ã‚„ã‘ã‚­ãƒ³ã‚°';
          if (sub) sub.textContent = 'Unit4 ãƒœã‚¹ï¼šã²ã‚„ã‘ã‚­ãƒ³ã‚°ï¼ˆå¤ã®ç‹ã•ã¾ï¼‰';
        }else if (u === '5'){
          fig.classList.add('skin-travelgate');
          label.textContent = 'ãƒˆãƒ©ãƒ™ãƒ«ã‚²ãƒ¼ãƒˆ';
          if (sub) sub.textContent = 'Unit5 ãƒœã‚¹ï¼šãƒˆãƒ©ãƒ™ãƒ«ã‚²ãƒ¼ãƒˆï¼ˆæœªæ¥ã®æ—…ã‚²ãƒ¼ãƒˆï¼‰';
        }else{
          label.textContent = 'ãƒŠãƒã‚¨ã‚¤ã‚¨ãƒ¼ãƒ«';
          if (sub) sub.textContent = '';
        }
      }
      applyBossSkin();

      let bossMaxHp   = 5;
      let bossHp      = 5;
      let playerMaxHp = 3;
      let playerHp    = 3;

      let bossItems      = [];
      let currentIndex   = 0;
      let questionStart  = 0;
      let gameFinished   = false;
      let currentItem    = null;
      let draggingWordEl = null;

      function setActionButtonsEnabled(enabled){
        checkBtn.disabled = !enabled;
        resetBtn.disabled = !enabled;
      }

      let nextPrefetch = null;
      let isTransitioning = false;

      function saveBossState(){
        if (!SAVE_KEY || !bossItems.length) return;
        const state = {
          bossHp, bossMaxHp,
          playerHp, playerMaxHp,
          currentIndex,
          itemIds: bossItems.map(it => it.id),
        };
        try{
          sessionStorage.setItem(SAVE_KEY, JSON.stringify(state));
        }catch(e){}
      }

      function loadBossState(){
        if (!SAVE_KEY) return null;
        const raw = sessionStorage.getItem(SAVE_KEY);
        if (!raw) return null;
        try{
          return JSON.parse(raw);
        }catch(e){
          return null;
        }
      }

      function clearBossState(){
        if (!SAVE_KEY) return;
        sessionStorage.removeItem(SAVE_KEY);
      }

      homeBtn.addEventListener('click', () => {
        exitModal.style.display = 'flex';
      });
      cancelExitBtn.addEventListener('click', () => {
        exitModal.style.display = 'none';
      });

      resetGameBtn.addEventListener('click', () => {
        clearBossState();
        exitModal.style.display = 'none';
        goToMenu();
      });

      saveGameBtn.addEventListener('click', () => {
        saveBossState();
        exitModal.style.display = 'none';
        goToMenu();
      });

      function playHitSound(kind){
        try{
          const AudioCtx = window.AudioContext || window.webkitAudioContext;
          if (!AudioCtx) return;
          const ctx = playHitSound._ctx || new AudioCtx();
          playHitSound._ctx = ctx;

          const now = ctx.currentTime;
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();

          osc.type = (kind === 'boss') ? 'triangle' : 'square';
          const baseFreq = (kind === 'player') ? 220 : 900;
          osc.frequency.setValueAtTime(baseFreq, now);
          osc.frequency.exponentialRampToValueAtTime(
            kind === 'boss' ? baseFreq * 1.4 : baseFreq / 2,
            now + 0.18
          );

          gain.gain.setValueAtTime(0.5, now);
          gain.gain.exponentialRampToValueAtTime(0.001, now + 0.25);

          osc.connect(gain).connect(ctx.destination);
          osc.start(now);
          osc.stop(now + 0.27);
        }catch(e){}
      }

      function showBossSpeech(text, duration){
        if (!bossSpeech) return;
        bossSpeech.textContent = text;
        bossSpeech.classList.add('show');
        if (duration && duration > 0){
          clearTimeout(showBossSpeech._timer);
          showBossSpeech._timer = setTimeout(()=>{
            bossSpeech.classList.remove('show');
          }, duration);
        }
      }

      function animateBossHit(){
        if (!bossFace) return;
        bossFace.classList.add('hit');
        const msg = Math.random() < 0.5 ? 'ãã¯ã£â€¦ï¼' : 'ã‚„ã‚‹ãªâ€¦ï¼';
        showBossSpeech(msg, 1200);
        setTimeout(()=> bossFace.classList.remove('hit'), 700);
      }

      function animatePlayerHit(){
        if (screenFlash){
          screenFlash.classList.add('show');
          setTimeout(()=> screenFlash.classList.remove('show'), 220);
        }
        if (playerHpInner){
          playerHpInner.classList.add('hp-hit');
          setTimeout(()=> playerHpInner.classList.remove('hp-hit'), 320);
        }
      }

      function fetchItemById(id){
        return new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(item => resolve(item))
            .withFailureHandler(err => reject(err))
            .getItemById(id, TOKEN);
        });
      }

      function startPrefetchForIndex(idx){
        const entry = bossItems[idx];
        if (!entry || entry.id == null) {
          nextPrefetch = null;
          return;
        }
        const id = entry.id;

        nextPrefetch = {
          idx,
          id,
          ready:false,
          item:null,
          promise: fetchItemById(id).then(raw => {
            const personalized = applyNamePersonalization(raw);
            const finalItem = { ...personalized, id: personalized.id ?? id };
            if (nextPrefetch && nextPrefetch.idx === idx) {
              nextPrefetch.ready = true;
              nextPrefetch.item = finalItem;
            }
            return finalItem;
          })
        };
      }

      function getPrefetchedIfMatch(idx){
        if (nextPrefetch && nextPrefetch.idx === idx && nextPrefetch.ready) {
          return nextPrefetch.item;
        }
        return null;
      }

      function firstSuccess(promises){
        return new Promise((resolve, reject) => {
          let pending = promises.length;
          const errs = [];
          promises.forEach((p, i) => {
            Promise.resolve(p).then(resolve).catch(err => {
              errs[i] = err;
              pending -= 1;
              if (pending === 0) reject(errs.find(Boolean) || new Error('ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
            });
          });
        });
      }

      function getItemForIndex(idx){
        const entry = bossItems[idx];
        if (!entry || entry.id == null) return Promise.reject(new Error('IDãŒã‚ã‚Šã¾ã›ã‚“'));
        const id = entry.id;

        const pref = (nextPrefetch && nextPrefetch.idx === idx) ? nextPrefetch.promise : null;

        const delayedNormalFetch = new Promise((resolve, reject) => {
          setTimeout(() => {
            fetchItemById(id)
              .then(raw => {
                const personalized = applyNamePersonalization(raw);
                resolve({ ...personalized, id: personalized.id ?? id });
              })
              .catch(reject);
          }, PREFETCH_FALLBACK_START_MS);
        });

        if (!pref){
          return fetchItemById(id).then(raw => {
            const personalized = applyNamePersonalization(raw);
            return { ...personalized, id: personalized.id ?? id };
          });
        }

        return firstSuccess([pref, delayedNormalFetch]);
      }

      checkBtn.addEventListener('click', () => {
        if (gameFinished || !bossItems.length || !currentItem) return;
        if (isTransitioning) return;

        isTransitioning = true;
        setActionButtonsEnabled(false);

        const arranged = getArrangedWords();
        if (arranged.some(t => !t)){
          statusMsg.textContent = 'ã¾ã ç©ºã®ã¨ã“ã‚ãŒã‚ã‚‹ã‚ˆã€‚ã™ã¹ã¦ã®ã‚¹ãƒ­ãƒƒãƒˆã‚’ã†ã‚ã¦ã­ã€‚';
          statusMsg.className = 'status-msg status-ng';
          isTransitioning = false;
          setActionButtonsEnabled(true);
          return;
        }

        const userAnswer    = arranged.join(' ').trim();
        const correctAnswer = (currentItem.words || []).join(' ').trim();
        const ok            = userAnswer === correctAnswer;
        const timeMs        = Date.now() - questionStart;

        if (TOKEN && currentItem && currentItem.id != null){
          google.script.run
            .withFailureHandler(err => console.log('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', err))
            .recordResult(TOKEN, currentItem.id, ok, timeMs, 'boss');
        }

        handleJudge(ok, currentItem, timeMs);
      });

      resetBtn.addEventListener('click', () => {
        if (gameFinished || !bossItems.length || !currentItem) return;
        if (isTransitioning) return;
        setupQuestion(currentItem);
        statusMsg.textContent = '';
        statusMsg.className = 'status-msg';
      });

      function handleJudge(ok, item, timeMs) {
        const nextIndex = ok
          ? ((currentIndex + 1) >= bossItems.length ? 0 : (currentIndex + 1))
          : currentIndex;

        if (ok) {
          bossHp = Math.max(0, bossHp - 1);
          updateHpBars();
          playHitSound('boss');
          animateBossHit();
          statusMsg.textContent = 'â­• æ­£è§£ï¼ ãƒœã‚¹ã«ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼';
          statusMsg.className = 'status-msg status-ok';

          currentIndex = nextIndex;
          startPrefetchForIndex(currentIndex);

        } else {
          playerHp = Math.max(0, playerHp - 1);
          updateHpBars();
          playHitSound('player');
          animatePlayerHit();
          const correctText = (item.words || []).join(' ');
          statusMsg.textContent = `âŒ ã–ã‚“ã­ã‚“â€¦ æ­£è§£ã¯ã€Œ${correctText}ã€ã ã‚ˆã€‚ã‚‚ã†ä¸€å›ï¼`;
          statusMsg.className = 'status-msg status-ng';
        }

        saveBossState();

        if (bossHp <= 0) { endGame(true); return; }
        if (playerHp <= 0) { endGame(false); return; }

        setTimeout(() => {
          if (gameFinished) return;

          if (ok) {
            const expectedIdx = currentIndex;

            const pref = getPrefetchedIfMatch(expectedIdx);
            if (pref) {
              setupQuestion(pref);
              statusMsg.textContent = '';
              statusMsg.className = 'status-msg';
              isTransitioning = false;
              setActionButtonsEnabled(true);
              prefetchNextAfterShown();
              return;
            }

            statusMsg.textContent = 'ã¤ãã®å•é¡Œã‚’èª­ã¿è¾¼ã¿ä¸­â€¦';
            statusMsg.className = 'status-msg';

            getItemForIndex(expectedIdx)
              .then(nextItem => {
                if (gameFinished) return;
                if (expectedIdx !== currentIndex) return;
                setupQuestion(nextItem);
                statusMsg.textContent = '';
                statusMsg.className = 'status-msg';
                isTransitioning = false;
                setActionButtonsEnabled(true);
                prefetchNextAfterShown();
              })
              .catch(err => {
                console.log('æ¬¡ã®å•é¡Œèª­ã¿è¾¼ã¿å¤±æ•—:', err);
                isTransitioning = false;
                loadCurrentQuestion();
              });

          } else {
            setupQuestion(currentItem);
            statusMsg.textContent = '';
            statusMsg.className = 'status-msg';
            isTransitioning = false;
            setActionButtonsEnabled(true);
            prefetchNextAfterShown();
          }
        }, NEXT_DELAY_MS);
      }

      function prefetchNextAfterShown(){
        if (!bossItems.length) return;
        const nextIdx = (currentIndex + 1) >= bossItems.length ? 0 : (currentIndex + 1);
        startPrefetchForIndex(nextIdx);
      }

      function restartBossBattle(){
        resultBanner.style.display = 'none';
        clearBossState();
        bossHp = bossMaxHp = 5;
        playerHp = playerMaxHp = 3;
        currentIndex = 0;
        gameFinished = false;
        isTransitioning = false;
        nextPrefetch = null;
        statusMsg.textContent = '';
        statusMsg.className = 'status-msg';
        loadBossItems(true);
      }
      window.restartBossBattle = restartBossBattle;

      function endGame(win) {
        gameFinished = true;
        isTransitioning = false;
        questionCard.style.display = 'none';
        clearBossState();

        resultBanner.style.display = 'block';
        resultBanner.className = 'result-banner ' + (win ? 'result-win' : 'result-lose');

        if (win) {
          const u = String(UNIT);
          const bossName =
            (u === '2') ? 'ã‚¨ãƒ™ãƒ³ãƒˆãƒ¢ãƒ³' :
            (u === '3') ? 'ãƒ‡ã‚¤ãƒªãƒ¼ã‚¹ãƒ©ã‚¤ãƒ ' :
            (u === '4') ? 'ã²ã‚„ã‘ã‚­ãƒ³ã‚°' :
            (u === '5') ? 'ãƒˆãƒ©ãƒ™ãƒ«ã‚²ãƒ¼ãƒˆ' :
            'ãƒŠãƒã‚¨ã‚¤ã‚¨ãƒ¼ãƒ«';

          resultBanner.innerHTML = `
            <div><strong>ğŸ‰ ãƒœã‚¹ã‚’ãŸãŠã—ãŸï¼ ãã¿ã®å‹ã¡ï¼</strong></div>
            <div>${bossName}ã‚‚ãŠã©ã‚ã„ã¦ã„ã‚‹ã‚ˆã€‚ã‚ˆããŒã‚“ã°ã£ãŸã­ï¼</div>
            <div class="result-buttons">
              <button type="button" class="home-btn" onclick="goToMenu()">
                ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ã‚‚ã©ã‚‹
              </button>
              <button type="button" class="home-btn" onclick="restartBossBattle()">
                ã‚‚ã†ä¸€åº¦ ãƒœã‚¹ã«æŒ‘æˆ¦
              </button>
            </div>
          `;
          showBossSpeech('ã¾ã„ã‚Šã¾ã—ãŸâ€¦ã¾ãŸæŒ‘æˆ¦ã—ã¦ã­ï¼', 0);
        } else {
          resultBanner.innerHTML = `
            <div><strong>ğŸ’¦ ã–ã‚“ã­ã‚“â€¦ ãƒœã‚¹ã«ã¯ã°ã¾ã‚ŒãŸï¼</strong></div>
            <div>ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ã‚„ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ã§ã€ã‚‚ã†å°‘ã—ã ã‘ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã—ã¦ã¿ã‚ˆã†ã€‚</div>
            <div class="result-buttons">
              <button type="button" class="home-btn" onclick="goToMenu()">
                ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ã‚‚ã©ã‚‹
              </button>
              <button type="button" class="home-btn" onclick="restartBossBattle()">
                ã‚‚ã†ä¸€åº¦ ãƒœã‚¹ã«æŒ‘æˆ¦
              </button>
            </div>
          `;
        }
      }

      function updateHpBars() {
        const bossPercent   = (bossHp   / bossMaxHp)   * 100;
        const playerPercent = (playerHp / playerMaxHp) * 100;

        bossHpInner.style.width   = bossPercent   + '%';
        playerHpInner.style.width = playerPercent + '%';

        bossHpText.textContent   = `${bossHp} / ${bossMaxHp}`;
        playerHpText.textContent = `${playerHp} / ${playerMaxHp}`;
      }

      function createSlot(){
        const slot = document.createElement('div');
        slot.className = 'slot';
        slot.textContent = '';

        slot.addEventListener('dragover', e => {
          e.preventDefault();
        });

        slot.addEventListener('drop', e => {
          e.preventDefault();
          if (!draggingWordEl) return;
          const word = draggingWordEl.textContent;

          if (slot.textContent){
            wordBank.appendChild(createWordChip(slot.textContent));
          }
          slot.textContent = word;
          slot.classList.add('filled');
          draggingWordEl.remove();
          draggingWordEl = null;
        });

        slot.addEventListener('click', () => {
          if (!slot.textContent) return;
          wordBank.appendChild(createWordChip(slot.textContent));
          slot.textContent = '';
          slot.classList.remove('filled');
        });

        return slot;
      }

      function createWordChip(word){
        const chip = document.createElement('div');
        chip.className = 'word-chip';
        chip.textContent = word;
        chip.draggable = true;

        chip.addEventListener('dragstart', e => {
          draggingWordEl = chip;
          e.dataTransfer.setData('text/plain', word);
        });

        chip.addEventListener('dragend', () => {
          draggingWordEl = null;
        });

        chip.addEventListener('click', () => {
          const slots = [...answerArea.querySelectorAll('.slot')];
          const empty = slots.find(s => !s.textContent);
          if (!empty) return;
          empty.textContent = word;
          empty.classList.add('filled');
          chip.remove();
        });

        return chip;
      }

      function getArrangedWords(){
        const slots = [...answerArea.querySelectorAll('.slot')];
        return slots.map(s => s.textContent.trim());
      }

      function setupQuestion(item) {
        currentItem = item;

        promptJpEl.textContent = item.prompt || 'ï¼ˆæ—¥æœ¬èªãŒæœªè¨­å®šã§ã™ï¼‰';
        qCountEl.textContent   = `å•é¡Œ ${currentIndex + 1} / ${bossItems.length}`;

        answerArea.innerHTML = '';
        wordBank.innerHTML   = '';
        draggingWordEl = null;

        const words = Array.from(item.words || []);
        words.forEach(() => {
          answerArea.appendChild(createSlot());
        });

        shuffle(words).forEach(w => {
          wordBank.appendChild(createWordChip(w));
        });

        questionStart = Date.now();
        setActionButtonsEnabled(true);
      }

      function shuffle(arr) {
        return arr
          .map(v => ({ v, r: Math.random() }))
          .sort((a,b) => a.r - b.r)
          .map(o => o.v);
      }

      function applyNamePersonalization(item){
        if (!item || typeof item !== 'object') return item;

        const cloned = { ...item };

        const rawKana = (cloned.full_name_kana || cloned.fullNameKana || '').trim();
        if (cloned.prompt && typeof cloned.prompt === 'string' && rawKana && rawKana.includes(' ')) {
          const firstKana = rawKana.split(' ')[0].trim();
          if (firstKana) {
            cloned.prompt = cloned.prompt.replace(/ã€‡ã€‡/g, firstKana);
          }
        }

        const firstEn = (cloned.first_name_en || cloned.firstNameEn || '').trim();
        const baseCorrect = (cloned.correct_sentence || cloned.correctSentence || '').trim();

        if (baseCorrect === 'I am' && firstEn) {
          const fullSentence = `I am ${firstEn}`;
          cloned.correct_sentence = fullSentence;
          if (cloned.correctSentence != null) {
            cloned.correctSentence = fullSentence;
          }

          if (Array.isArray(cloned.words)) {
            const w = cloned.words.map(v => String(v));
            if (w.length === 2 && w[0] === 'I' && w[1] === 'am') {
              cloned.words = ['I','am', firstEn];
            }
          }
        }

        return cloned;
      }

      function loadCurrentQuestion(){
        if (!bossItems.length) return;
        const entry = bossItems[currentIndex];
        if (!entry || entry.id == null) return;

        statusMsg.textContent = 'èª­ã¿è¾¼ã¿ä¸­â€¦';
        statusMsg.className   = 'status-msg';

        setActionButtonsEnabled(false);

        google.script.run
          .withSuccessHandler(item => {
            const personalized = applyNamePersonalization(item);
            currentItem = {
              ...personalized,
              id: personalized.id ?? entry.id,
            };
            setupQuestion(currentItem);
            statusMsg.textContent = '';
            statusMsg.className   = 'status-msg';
            isTransitioning = false;
            prefetchNextAfterShown();
          })
          .withFailureHandler(err => {
            console.log(err);
            statusMsg.textContent = 'èª­ã¿è¾¼ã¿ãŒã†ã¾ãã„ã‹ã‚“ã‹ã£ãŸâ€¦ã‚‚ã†ä¸€å›ãŸã‚ã—ã¦ã¿ã¦ã­ã€‚';
            statusMsg.className   = 'status-msg status-ng';
            isTransitioning = false;
            setActionButtonsEnabled(true);
          })
          .getItemById(entry.id, TOKEN);
      }

      function startGameFromItems(idList, restoredState){
        bossItems = idList.map(id => ({ id }));

        if (bossItems.length < 5) {
          needMoreEl.style.display   = 'block';
          bossArea.style.display     = 'none';
          questionCard.style.display = 'none';
          return;
        }

        needMoreEl.style.display   = 'none';
        bossArea.style.display     = 'flex';
        questionCard.style.display = 'block';
        resultBanner.style.display = 'none';

        if (restoredState){
          bossMaxHp   = restoredState.bossMaxHp   || 5;
          bossHp      = restoredState.bossHp      ?? 5;
          playerMaxHp = restoredState.playerMaxHp || 3;
          playerHp    = restoredState.playerHp    ?? 3;
          currentIndex= restoredState.currentIndex || 0;
        }else{
          bossHp = bossMaxHp = 5;
          playerHp = playerMaxHp = 3;
          currentIndex = 0;
        }

        if (currentIndex >= bossItems.length) currentIndex = 0;

        gameFinished = false;
        isTransitioning = false;
        nextPrefetch = null;
        updateHpBars();
        saveBossState();
        loadCurrentQuestion();
      }

      function loadBossItems(forceNew){
        const restored = forceNew ? null : loadBossState();

        if (restored){
          let ids = [];
          if (Array.isArray(restored.itemIds) && restored.itemIds.length){
            ids = restored.itemIds.map(n => Number(n)).filter(n => Number.isFinite(n));
          }else if (Array.isArray(restored.items) && restored.items.length){
            ids = restored.items.map(it => {
              const rawId = it.id ?? it.itemId ?? it.item_id ?? it.ID;
              const numId = Number(rawId);
              return Number.isFinite(numId) ? numId : null;
            }).filter(id => id !== null);
          }

          if (ids.length){
            startGameFromItems(ids, restored);
            return;
          }
        }

        google.script.run
          .withSuccessHandler(res => {
            const rawItems = (res && res.items) || [];

            const allIds = rawItems
              .map(it => {
                const rawId = it.id ?? it.itemId ?? it.item_id ?? it.ID;
                const numId = Number(rawId);
                return Number.isFinite(numId) ? numId : null;
              })
              .filter(id => id !== null);

            if (allIds.length < 5) {
              needMoreEl.style.display   = 'block';
              bossArea.style.display     = 'none';
              questionCard.style.display = 'none';
              return;
            }

            const pickedIds = shuffle(allIds).slice(0, 5);
            startGameFromItems(pickedIds, null);
          })
          .withFailureHandler(err => {
            console.log(err);
            needMoreEl.style.display = 'block';
            needMoreEl.textContent = 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã§ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦ã‚‚ã†ä¸€åº¦ãŸã‚ã—ã¦ãã ã•ã„ã€‚';
          })
          .getBossItems(TOKEN, UNIT || '');
      }

      setActionButtonsEnabled(false);
      loadBossItems(false);
    </script>
  </body>
</html>
