<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ë™ûÈ†Ü„ÅßGOÔºÅ | „Éõ„Éº„É†</title>

    <style>
      :root{
        --bg:#fff7ed; --panel:#fff1e6; --border:#ffd7b8;
        --text:#3b2a1a; --muted:#8a6a4a;
        --accent:#f97316; --accent-600:#ea580c;
      }
      *{ box-sizing:border-box; }
      html,body{ height:100%; margin:0; }
      body{
        display:flex;
        align-items:center;
        justify-content:center;
        font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP","Yu Gothic",Meiryo,sans-serif;
        background:radial-gradient(1000px 600px at 20% -10%, #fff 10%, var(--bg) 60%),
                   radial-gradient(800px 500px at 120% 10%, #fff 0%, var(--bg) 60%);
        color:var(--text);
      }
      .frame{
        width:min(780px, 100% - 32px);
        background:var(--panel);
        border-radius:28px;
        border:2px solid var(--border);
        box-shadow:0 18px 40px rgba(249,115,22,.2);
        padding:24px 26px 22px;
      }

      .title-row{
        display:flex;
        align-items:center;
        justify-content:center;
        gap:12px;
        margin-bottom:4px;
      }
      .user-label{
        font-size:16px;
        font-weight:700;
        color:var(--text);
        white-space:nowrap;
      }
      .title{
        text-align:center;
        font-size:32px;
        font-weight:900;
        margin:0;
        letter-spacing:.06em;
        background:linear-gradient(90deg,var(--accent) 0%,#fb923c 40%,#f59e0b 100%);
        -webkit-background-clip:text;
        background-clip:text;
        color:transparent;
      }

      /* ‚òÖÂ∑Æ„ÅóÊõø„ÅàÔºö„É¶„Éã„ÉÉ„ÉàÂà•„Ç≥„Ç§„É≥Ë°®Á§∫ */
      .coins-wrap{
        margin:10px auto 8px;
        width:min(560px, 100%);
        background:#fff;
        border:2px solid #fed7aa;
        border-radius:18px;
        padding:10px 12px 12px;
        box-shadow:0 8px 18px rgba(249,115,22,.10);
      }
      .coins-head{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:8px;
        flex-wrap:wrap;
        margin-bottom:8px;
      }
      .coins-title{
        font-size:12px;
        color:var(--muted);
        font-weight:900;
        letter-spacing:.08em;
      }
      .coins-note{
        font-size:12px;
        color:#b45309;
        font-weight:900;
        background:#fff7ed;
        border:1px solid #fed7aa;
        padding:4px 10px;
        border-radius:999px;
        white-space:nowrap;
      }
      .coins-grid{
        display:grid;
        grid-template-columns:repeat(4, 1fr);
        gap:8px;
      }
      @media (max-width:560px){
        .coins-grid{ grid-template-columns:repeat(2, 1fr); }
      }
      .coin-chip{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:8px;
        border:2px solid #ffe0c2;
        background:linear-gradient(180deg,#fff7ed 0%, #fff 70%);
        border-radius:14px;
        padding:10px 12px;
      }
      .coin-chip .u{
        font-weight:1000;
        color:#7c2d12;
      }
      .coin-chip .v{
        font-weight:1000;
        color:#92400e;
        font-size:18px;
      }

      .subtitle{
        text-align:center;
        font-size:14px;
        color:var(--muted);
        margin-bottom:16px;
      }

      .table{
        margin-top:12px;
        border-top:1px solid #fed7aa;
      }
      .row{
        display:flex;
        align-items:center;
        justify-content:space-between;
        padding:10px 2px;
        border-bottom:1px dashed #fed7aa;
      }
      .unit-name{
        font-weight:700;
        font-size:16px;
      }
      .btn-group{
        display:flex;
        gap:8px;
      }

      button{
        font-family:inherit;
        min-width:84px;
        padding:6px 12px;
        font-size:14px;
        border-radius:999px;
        border:2px solid #fed7aa;
        cursor:pointer;
        font-weight:700;
        box-shadow:0 1px 2px rgba(0,0,0,.05);
      }
      .btn-practice{
        background:#fff;
        color:#b45309;
      }
      .btn-challenge{
        background:linear-gradient(180deg,#ffb777 0%,#ff914d 100%);
        border-color:#f97316;
        color:#3b2314;
      }
      .btn-list-inline{
        background:#fff;
        color:#b45309;
        min-width:80px;
      }

      .footer{
        margin-top:14px;
        text-align:center;
        font-size:12px;
        color:var(--muted);
      }
      .logout-btn{
        margin-top:8px;
        padding:4px 12px;
        font-size:11px;
        border-radius:999px;
        border:1px solid #fed7aa;
        background:#fff;
        color:var(--muted);
        cursor:pointer;
      }
    </style>
  </head>

  <body>
    <div class="frame">
      <div class="title-row">
        <div id="userLabel" class="user-label"></div>
        <h1 class="title">Ë™ûÈ†Ü„ÅßGOÔºÅ</h1>
      </div>

      <!-- ‚òÖÂ∑Æ„ÅóÊõø„ÅàÔºö„É¶„Éã„ÉÉ„ÉàÂà•„Ç≥„Ç§„É≥ -->
      <div class="coins-wrap" aria-label="„É¶„Éã„ÉÉ„ÉàÂà•„Ç≥„Ç§„É≥">
        <div class="coins-head">
          <div class="coins-title">UNIT COINS</div>
          <div class="coins-note">ü™ô „ÅÑ„Åæ„ÅÆ„Ç≥„Ç§„É≥</div>
        </div>
        <div class="coins-grid" id="coinsGrid">
          <!-- JS„Åß‰Ωú„Çã -->
        </div>
      </div>

      <div class="subtitle">„ÅÇ„Åù„Å∂ Unit „Å®„É¢„Éº„Éâ„Çí„Åà„Çâ„Åº„ÅÜÔºÅ</div>

      <div class="table" id="unitTable"></div>

      <div class="footer">
        „Åü„Åè„Åï„ÇìÁ∑¥Áøí„Åó„Å¶Ë™ûÈ†Ü„Çí„Éû„Çπ„Çø„Éº„Åó„Çà„ÅÜÔºÅÔºÅ<br>
        <button id="btnLogout" type="button" class="logout-btn">„É≠„Ç∞„Ç§„É≥ÁîªÈù¢„Å´„ÇÇ„Å©„Çã</button>
      </div>
    </div>

    <script>
      const STORAGE_KEY_BASE = 'go_execBaseUrl';

      // ‚òÖ exec „ÅÆ„Éô„Éº„ÇπURLÔºà„Çµ„Éº„Éê„ÉºÂüã„ÇÅËæº„Åø„ÇíÊúÄÂÑ™ÂÖà ‚Üí ËøΩÂæìÔºâ
      const EXEC_BASE = (() => {
        const url = '<?= ScriptApp.getService().getUrl() ?>' || '';
        const base = (url.split('?')[0] || '').trim();
        const fallback = (() => {
          try{
            const u = new URL(window.location.href);
            return u.origin + u.pathname;
          }catch(e){
            return window.location.href;
          }
        })();
        const decided = base || sessionStorage.getItem(STORAGE_KEY_BASE) || fallback;
        try{ sessionStorage.setItem(STORAGE_KEY_BASE, decided); }catch(e){}
        return decided;
      })();

      const EMBED_TOKEN = '<?= typeof token !== "undefined" ? token : "" ?>';
      let TOKEN = null;

      // token ÂèñÂæó
      const resolveToken = cb => {
        if (EMBED_TOKEN){
          TOKEN = EMBED_TOKEN;
          cb();
          return;
        }

        if (window.google && google.script && google.script.url){
          google.script.url.getLocation(loc => {
            TOKEN = (loc && loc.parameter && loc.parameter.t) ? String(loc.parameter.t) : '';
            cb();
          });
          return;
        }
        const p = new URLSearchParams(location.search);
        TOKEN = p.get('t') || '';
        cb();
      };

      // „É¶„Éã„ÉÉ„ÉàË°®
      const buildUnits = () => {
        const table = document.getElementById('unitTable');
        table.innerHTML = '';

        for (let i = 1; i <= 8; i++){
          const row = document.createElement('div');
          row.className = 'row';

          const name = document.createElement('div');
          name.className = 'unit-name';
          name.textContent = 'Unit ' + i;

          const btns = document.createElement('div');
          btns.className = 'btn-group';

          const bList = document.createElement('button');
          bList.className = 'btn-list-inline';
          bList.textContent = 'ÈõÜ‰∏≠Á∑¥Áøí';
          bList.addEventListener('click', () => goFocusList(i));
          btns.appendChild(bList);

          const bReview = document.createElement('button');
          bReview.className = 'btn-practice';
          bReview.textContent = 'Âæ©Áøí';
          bReview.addEventListener('click', () => goReview(i));
          btns.appendChild(bReview);

          const bPractice = document.createElement('button');
          bPractice.className = 'btn-practice';
          bPractice.textContent = 'Á∑¥Áøí';
          bPractice.addEventListener('click', () => goGame(i,'practice'));
          btns.appendChild(bPractice);

          const bChallenge = document.createElement('button');
          bChallenge.className = 'btn-challenge';
          bChallenge.textContent = '„ÉÅ„É£„É¨„É≥„Ç∏';
          // ‚úÖ „ÉÅ„É£„É¨„É≥„Ç∏„ÅØ challenge_menu „Å´È£õ„Å∞„Åô
          bChallenge.addEventListener('click', () => goChallengeMenu(i));
          btns.appendChild(bChallenge);

          row.appendChild(name);
          row.appendChild(btns);
          table.appendChild(row);
        }
      };

      // Á∑¥Áøí„Éª„ÉÅ„É£„É¨„É≥„Ç∏ÔºàÊó¢Â≠ò„ÅÆ„Åæ„ÅæÊÆã„ÅôÔºö‰ªñ„Åß‰Ωø„Å£„Å¶„Å¶„ÇÇÂ£ä„Åï„Å™„ÅÑ„Åü„ÇÅÔºâ
      const goGame = (unit, mode) => {
        if (!TOKEN){
          alert('„É≠„Ç∞„Ç§„É≥ÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Å≠„ÄÇ');
          return;
        }
        const page = (mode === 'practice') ? 'game_practice' : 'game_challenge';

        const url =
          EXEC_BASE
          + '?page=' + encodeURIComponent(page)
          + '&t='    + encodeURIComponent(TOKEN)
          + '&unit=' + encodeURIComponent(unit)
          + '&mode=' + encodeURIComponent(mode);

        try{ window.top.location.href = url; }
        catch(_){ window.location.href = url; }
      };

      // ‚úÖ „ÉÅ„É£„É¨„É≥„Ç∏„É°„Éã„É•„Éº„Å∏
      const goChallengeMenu = unit => {
        if (!TOKEN){
          alert('„É≠„Ç∞„Ç§„É≥ÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Å≠„ÄÇ');
          return;
        }
        const url =
          EXEC_BASE
          + '?page=challenge_menu'
          + '&t='    + encodeURIComponent(TOKEN)
          + '&unit=' + encodeURIComponent(unit);
        try{ window.top.location.href = url; }
        catch(_){ window.location.href = url; }
      };

      // ‚úÖ Âæ©Áøí„Éú„Çø„É≥„ÅØ game_stamp „Å´Áõ¥Ë°åÔºàÊó¢Â≠ò„Å©„Åä„ÇäÔºâ
      const goReview = unit => {
        if (!TOKEN){
          alert('„É≠„Ç∞„Ç§„É≥ÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Å≠„ÄÇ');
          return;
        }
        const url =
          EXEC_BASE
          + '?page=game_stamp'
          + '&t='    + encodeURIComponent(TOKEN)
          + '&unit=' + encodeURIComponent(unit);
        try{ window.top.location.href = url; }
        catch(_){ window.location.href = url; }
      };

      // ÈõÜ‰∏≠Á∑¥Áøí
      const goFocusList = unit => {
        if (!TOKEN){
          alert('„É≠„Ç∞„Ç§„É≥ÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Å≠„ÄÇ');
          return;
        }
        const url =
          EXEC_BASE
          + '?page=game_focus'
          + '&t='    + encodeURIComponent(TOKEN)
          + '&unit=' + encodeURIComponent(unit);
        try{ window.top.location.href = url; }
        catch(_){ window.location.href = url; }
      };

      // ‚òÖ„É¶„Éã„ÉÉ„ÉàÂà•„Ç≥„Ç§„É≥Ë°®Á§∫Ôºà+ challenge_menu Áî®„Å´ sessionStorage „Å∏‰øùÂ≠òÔºâ
      const renderCoins = (coinsByUnit) => {
        const grid = document.getElementById('coinsGrid');
        grid.innerHTML = '';
        for (let u = 1; u <= 8; u++){
          const v = Number(coinsByUnit?.[u] || 0);
          const chip = document.createElement('div');
          chip.className = 'coin-chip';
          chip.innerHTML = `<div class="u">Unit ${u}</div><div class="v">ü™ô ${v}</div>`;
          grid.appendChild(chip);
        }
      };

      const cacheCoinsToSession = (coinsByUnit, unlockByUnit) => {
        if (!TOKEN) return;
        try{
          for (let u = 1; u <= 8; u++){
            const c = Number(coinsByUnit?.[u] || 0);
            sessionStorage.setItem(`go_coin_${TOKEN}_u${u}`, String(c));
            const ul = !!(unlockByUnit && unlockByUnit[u]);
            sessionStorage.setItem(`go_unlockChallenge_${TOKEN}_u${u}`, ul ? '1' : '0');
          }
        }catch(e){}
      };

      // ‚òÖ„ÄêËøΩÂä†ÔºàÊúÄÂ∞èÔºâ„ÄëcoinsByUnit / unlockByUnit „Çí„Å©„Çì„Å™ÂΩ¢„Åß„ÇÇ 1..8 „ÅÆMap„Å´Ê≠£Ë¶èÂåñ
      // - ‰æã1: {1:5,2:0,...}
      // - ‰æã2: {u1:5,u2:0,...}
      // - ‰æã3: [5,0,0,...] (0-index)
      // - ‰æã4: [null,5,0,...] (1-index)
      const normalizeByUnit = (srcAny) => {
        const out = {};
        const src = srcAny || {};
        const isArr = Array.isArray(src);

        // ÈÖçÂàó„Å™„Çâ„Äå1-index„Å£„ÅΩ„ÅÑ„Äç„Åã„Äå0-index„Å£„ÅΩ„ÅÑ„Äç„Åã„Çí„Åñ„Å£„Åè„ÇäÂà§ÂÆö
        // length>=9 „Å™„Çâ 1-index„ÅÆÂèØËÉΩÊÄß„ÅåÈ´ò„ÅÑ„ÅÆ„Åß u „Çí„Åù„ÅÆ„Åæ„Åæ
        const arrIndex = (u) => {
          if (!isArr) return null;
          if (src.length >= 9) return u;     // [0, val1, val2 ...] „Å£„ÅΩ„ÅÑ
          return u - 1;                      // [val1, val2 ...] „Å£„ÅΩ„ÅÑ
        };

        for (let u = 1; u <= 8; u++){
          let v = 0;

          if (isArr){
            const idx = arrIndex(u);
            v = Number(src[idx] || 0);
          }else{
            // Êï∞Â≠ó„Ç≠„Éº / ÊñáÂ≠ó„Ç≠„Éº / u1ÂΩ¢Âºè„ÇíÂÖ®ÈÉ®Êãæ„ÅÜ
            v =
              Number(src[u] ?? 0) ||
              Number(src[String(u)] ?? 0) ||
              Number(src[`u${u}`] ?? 0) ||
              0;
          }
          out[u] = Number.isFinite(v) ? v : 0;
        }
        return out;
      };

      // ‚òÖ„ÄêËøΩÂä†ÔºàÊúÄÂ∞èÔºâ„Äëcoin_uX / unlock_challenge_uX „ÇíÊãæ„ÅÜÔºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÁî®Ôºâ
      const pickCoinsUnlock = (obj) => {
        const coinsByUnit = {};
        const unlockByUnit = {};
        const src = obj || {};
        for (let u = 1; u <= 8; u++){
          coinsByUnit[u] = Number(src?.[`coin_u${u}`] || 0);
          unlockByUnit[u] = !!src?.[`unlock_challenge_u${u}`];
        }
        return { coinsByUnit, unlockByUnit };
      };

      // ‚òÖ ÂêçÂâçË°®Á§∫ÔºàÂ∑¶„ÅÆ„É©„Éô„É´„ÅØ ‚Äú„Éã„ÉÉ„ÇØ„Éç„Éº„É†‚Äù „ÇíÊúÄÂÑ™ÂÖà„ÅßÂÖÉ„Å´Êàª„ÅôÔºâÔºã„Ç≥„Ç§„É≥Ë°®Á§∫
      const updateUserLabel = () => {
        if (!TOKEN) return;
        if (!(window.google && google.script && google.script.run)) return;

        // ‚úÖ ‰øÆÊ≠£ÊñπÈáùÔºöA) getHomeStatus(token) „ÇíÊúÄÂÑ™ÂÖàÔºàcoinsByUnit „ÇíÊ≠£„ÅßËøî„ÅôÊÉ≥ÂÆöÔºâ
        google.script.run
          .withSuccessHandler(status => {
            // --- ÂêçÂâçÔºàÂãùÊâã„Å´Ê∂à„Åï„Å™„ÅÑÔºâÔºönickname ÂÑ™ÂÖà ---
            const nick =
              status?.nickname ||
              status?.student?.nickname ||
              status?.name ||
              status?.student?.name ||
              status?.student_id ||
              status?.student?.student_id ||
              status?.studentId ||
              status?.student?.studentId ||
              '';

            if (nick){
              document.getElementById('userLabel').textContent = `${nick}„Åï„Çì`;
            }

            // --- „Ç≥„Ç§„É≥ ---
            // coinsByUnit „Åå„ÅÇ„Çå„Å∞ÊúÄÂÑ™ÂÖàÔºàÂΩ¢„ÅØÊ≠£Ë¶èÂåñ„Åó„Å¶„Åã„Çâ‰Ωø„ÅÜÔºâ
            if (status && status.coinsByUnit){
              const coins = normalizeByUnit(status.coinsByUnit);
              const unlock = status.unlockByUnit ? normalizeByUnit(status.unlockByUnit) : {};
              renderCoins(coins);
              cacheCoinsToSession(coins, unlock);
              return;
            }

            // Âøµ„ÅÆ„Åü„ÇÅÔºöstatus/student „Å´ coin_uX „ÅåÂÖ•„Å£„Å¶„Çã„Ç±„Éº„Çπ„ÇÇÊãæ„ÅÜ
            const baseObj = status?.student || status;
            const picked = pickCoinsUnlock(baseObj);
            renderCoins(picked.coinsByUnit);
            cacheCoinsToSession(picked.coinsByUnit, picked.unlockByUnit);
          })
          .withFailureHandler(err => {
            // ‚úÖ Â§±ÊïóÊôÇÔºöÊó¢Â≠ò„Å©„Åä„Çä„ÄåË°®Á§∫„ÅØÂ¥©„Åï„Å™„ÅÑ„Äç„Åß getStudentByToken „Å´„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
            console.warn('getHomeStatus failed:', err);

            google.script.run
              .withSuccessHandler(stu => {
                const nick = stu?.nickname || stu?.name || stu?.student_id || '';
                if (nick){
                  document.getElementById('userLabel').textContent = `${nick}„Åï„Çì`;
                }
                const picked = pickCoinsUnlock(stu);
                renderCoins(picked.coinsByUnit);
                cacheCoinsToSession(picked.coinsByUnit, picked.unlockByUnit);
              })
              .withFailureHandler(__err => {
                console.warn('getStudentByToken failed:', __err);
                const fallback = {};
                for (let u = 1; u <= 8; u++) fallback[u] = 0;
                renderCoins(fallback);
              })
              .getStudentByToken(TOKEN);
          })
          .getHomeStatus(TOKEN);
      };

      // „É≠„Ç∞„Ç§„É≥ÁîªÈù¢„Å´Êàª„Çã
      const goLoginPage = () => {
        try{ window.top.location.href = EXEC_BASE; }
        catch(_){ window.location.href = EXEC_BASE; }
      };
      document.getElementById('btnLogout').addEventListener('click', goLoginPage);

      // ‚úÖ„ÄêËøΩÂä†ÔºàÊúÄÂ∞èÔºâ„ÄëÊàª„Çã/Âæ©Â∏∞„Åß„ÇÇÊúÄÊñ∞„ÇíÂèñ„Çä„Å´„ÅÑ„ÅèÔºàBÔºâ
      const refreshHome = () => {
        if (!TOKEN) return;
        updateUserLabel();
      };

      window.addEventListener('load', () => {
        resolveToken(() => {
          buildUnits();

          // ÂÖà„Å´ sessionStorage „Åã„Çâ‰ªÆË°®Á§∫Ôºà„Åô„ÅêÂá∫„ÇãÔºâ
          const coinsByUnit = {};
          for (let u = 1; u <= 8; u++){
            const v = Number(sessionStorage.getItem(`go_coin_${TOKEN}_u${u}`) || 0);
            coinsByUnit[u] = Number.isFinite(v) ? v : 0;
          }
          renderCoins(coinsByUnit);

          // „Åù„ÅÆ„ÅÇ„Å® GAS „ÅßÊúÄÊñ∞Âåñ
          updateUserLabel();

          // ‚úÖ Êàª„Çã/„Çø„ÉñÂæ©Â∏∞„Åß„ÇÇÊúÄÊñ∞ÂåñÔºàË°®Á§∫Êõ¥Êñ∞Êºè„ÇåÂØæÁ≠ñÔºâ
          window.addEventListener('pageshow', (e) => {
            if (e && e.persisted) refreshHome();
          });
          document.addEventListener('visibilitychange', () => {
            if (!document.hidden) refreshHome();
          });
        });
      });
    </script>
  </body>
</html>
