<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>èªé †ã§GOï¼ | å¾©ç¿’ãƒ¡ãƒ‹ãƒ¥ãƒ¼</title>

    <style>
      :root{
        --bg:#fff7ed; --panel:#fff1e6; --border:#ffd7b8;
        --text:#3b2a1a; --muted:#8a6a4a;
        --accent:#f97316; --accent-600:#ea580c;
      }
      *{ box-sizing:border-box; }
      html,body{ height:100%; margin:0; }
      body{
        display:flex; align-items:center; justify-content:center;
        font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP","Yu Gothic",Meiryo,sans-serif;
        background:radial-gradient(1000px 600px at 20% -10%, #fff 10%, var(--bg) 60%),
                   radial-gradient(800px 500px at 120% 10%, #fff 0%, var(--bg) 60%);
        color:var(--text);
      }

      .frame{
        width:min(780px, 100% - 32px);
        background:var(--panel);
        border-radius:28px;
        border:2px solid var(--border);
        box-shadow:0 18px 40px rgba(249,115,22,.2);
        padding:22px 22px 20px;
      }

      .header{
        display:flex;
        flex-wrap:wrap;
        justify-content:space-between;
        align-items:flex-start;
        gap:8px;
        margin-bottom:12px;
      }
      .title-block{
        display:flex;
        flex-wrap:wrap;
        align-items:center;
        gap:10px;
      }
      .title{
        font-size:26px;
        font-weight:900;
        margin:0;
        letter-spacing:.06em;
        background:linear-gradient(90deg,var(--accent) 0%,#fb923c 40%,#f59e0b 100%);
        -webkit-background-clip:text;
        background-clip:text;
        color:transparent;
      }
      .mode-tag{
        font-size:13px;
        padding:4px 10px;
        border-radius:999px;
        border:1px solid #fed7aa;
        background:#fff7ed;
        color:#b45309;
        font-weight:700;
      }
      .user-label{
        font-size:14px;
        font-weight:700;
        color:var(--text);
      }
      .unit-label{
        font-size:13px;
        color:var(--muted);
      }

      .logout-btn{
        padding:4px 12px;
        font-size:11px;
        border-radius:999px;
        border:1px solid #fed7aa;
        background:#fff;
        color:var(--muted);
        cursor:pointer;
      }

      .intro{
        font-size:14px;
        color:var(--muted);
        margin-bottom:14px;
      }

      .cards{
        display:grid;
        grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
        gap:12px;
        margin-bottom:14px;
      }

      .card{
        background:#fff;
        border-radius:22px;
        border:2px solid #fed7aa;
        padding:14px 14px 12px;
        box-shadow:0 4px 10px rgba(0,0,0,.04);
      }
      .card-title{
        display:flex;
        align-items:center;
        gap:8px;
        margin-bottom:4px;
      }
      .card-title span{
        font-size:18px;
        font-weight:800;
      }
      .badge{
        font-size:11px;
        padding:2px 8px;
        border-radius:999px;
        border:1px solid #fed7aa;
        background:#fff7ed;
        color:#b45309;
        font-weight:700;
      }
      .card-desc{
        font-size:13px;
        color:var(--muted);
        margin-bottom:8px;
        min-height:36px;
      }
      .card-state{
        font-size:13px;
        margin-bottom:8px;
      }
      .card-state strong{
        font-weight:800;
      }

      button{
        font-family:inherit;
        cursor:pointer;
        border-radius:999px;
        border:2px solid #fed7aa;
        padding:10px 18px;
        font-size:15px;
        font-weight:700;
        min-width:160px;
        min-height:48px;
        box-shadow:0 1px 2px rgba(0,0,0,.05);
        transition:transform .05s, box-shadow .12s, opacity .15s;
      }
      button:hover:not(:disabled){
        box-shadow:0 6px 14px rgba(249,115,22,.18);
        transform:translateY(-1px);
      }
      button:active:not(:disabled){
        transform:translateY(0);
        box-shadow:0 2px 6px rgba(249,115,22,.18);
      }
      button:disabled{
        opacity:.5;
        cursor:default;
      }

      .btn-primary{
        background:linear-gradient(180deg,#ffb777 0%,#ff914d 100%);
        border-color:#f97316;
        color:#3b2314;
      }
      .btn-secondary{
        background:#fff;
        color:#b45309;
      }

      .footer{
        margin-top:6px;
        font-size:12px;
        color:var(--muted);
        text-align:center;
      }
      .footer a{
        color:var(--accent-600);
        text-decoration:none;
        font-weight:700;
      }
    </style>
  </head>

  <body>
    <div class="frame">
      <div class="header">
        <div>
          <div class="title-block">
            <h1 class="title">èªé †ã§GOï¼</h1>
            <span class="mode-tag">å¾©ç¿’ãƒ¡ãƒ‹ãƒ¥ãƒ¼</span>
          </div>
          <div class="user-label" id="userLabel"></div>
          <div class="unit-label" id="unitLabel"></div>
        </div>
        <div>
          <button id="btnHome" class="logout-btn" type="button">ãƒ›ãƒ¼ãƒ ç”»é¢ã«ã‚‚ã©ã‚‹</button><br>
          <button id="btnLogout" class="logout-btn" type="button" style="margin-top:4px;">
            ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ã‚‚ã©ã‚‹
          </button>
        </div>
      </div>

      <p class="intro">
        ã€Œã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ã€ã¨ã€Œãƒœã‚¹è¨ä¼ã€ã‹ã‚‰ãˆã‚‰ã‚“ã§å¾©ç¿’ã—ã‚ˆã†ï¼âœ¨
      </p>

      <div class="cards">
        <!-- ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ -->
        <section class="card">
          <div class="card-title">
            <span>ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼</span>
            <span class="badge">ä¸­æœŸçš„å¾©ç¿’</span>
          </div>
          <p class="card-desc">
            ã¾ã¡ãŒãˆãŸæ–‡ã”ã¨ã«ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ã‚ã¤ã‚ã‚ˆã†ï¼<br>
            2å›ãƒ»5å›ãƒ»8å› æ­£è§£ã§ã‚­ãƒ©ã‚­ãƒ©ã€Œã‚¯ãƒªã‚¢ã€ãŒå‡ºã‚‹ã‚ˆ âœ¨
          </p>
          <p class="card-state" id="stampState">
            èª­ã¿è¾¼ã¿ä¸­â€¦
          </p>
          <button id="btnStamp" class="btn-primary" type="button">
            ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ã‚’ã™ã‚‹
          </button>
        </section>

        <!-- ãƒœã‚¹è¨ä¼ -->
        <section class="card">
          <div class="card-title">
            <span>ãƒœã‚¹è¨ä¼</span>
            <span class="badge">é•·æœŸçš„å¾©ç¿’</span>
          </div>
          <p class="card-desc">
            ã¾ã¡ãŒãˆãŸå•é¡Œã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«5å•å‡ºé¡Œï¼<br>
            ãƒãƒ¼ãƒˆ3ã¤ã§ãƒœã‚¹ã«ã„ã©ã‚‚ã† ğŸ’¥
          </p>
          <p class="card-state" id="bossState">
            èª­ã¿è¾¼ã¿ä¸­â€¦
          </p>
          <!-- ãƒœã‚¿ãƒ³è‰²ï¼šã‚¹ã‚¿ãƒ³ãƒ—ã¨åŒã˜ã‚ªãƒ¬ãƒ³ã‚¸ -->
          <button id="btnBoss" class="btn-primary" type="button" disabled>
            ãƒœã‚¹è¨ä¼ã«ã¡ã‚‡ã†ã›ã‚“
          </button>
        </section>
      </div>

      <div class="footer">
        ã¾ã¡ãŒãˆãŸå•é¡Œã‚’å‘³æ–¹ã«ã—ã¦ã€èªé †ãƒã‚¹ã‚¿ãƒ¼ã‚’ã‚ã–ãã†ï¼ğŸ’ª
      </div>
    </div>

    <script>
      const STORAGE_KEY_BASE = 'go_execBaseUrl';

      // â˜… EXEC_BASE ã‚’ ScriptApp.getService().getUrl() ãƒ™ãƒ¼ã‚¹ã«çµ±ä¸€
      const EXEC_BASE = (() => {
        const url = '<?= ScriptApp.getService().getUrl() ?>' || '';
        const base = url.split('?')[0] || window.location.href.split('?')[0];

        try {
          // ã„ã¡ãŠã†ä»–ãƒšãƒ¼ã‚¸å‘ã‘ã«ä¿å­˜ã‚‚ã—ã¦ãŠãï¼ˆå¾“æ¥ä»•æ§˜ã‚’ã‚­ãƒ¼ãƒ—ï¼‰
          sessionStorage.setItem(STORAGE_KEY_BASE, base);
        } catch (e) {}

        return base;
      })();

      const EMBED_TOKEN = '<?= typeof token !== "undefined" ? token : "" ?>';
      const EMBED_UNIT  = '<?= typeof unit  !== "undefined" ? unit  : "" ?>';

      let TOKEN = null;
      let UNIT  = null;

      function resolveTokenAndUnit(cb){
        if (EMBED_TOKEN){
          TOKEN = EMBED_TOKEN;
          UNIT  = EMBED_UNIT || '';
          cb();
          return;
        }

        if (window.google && google.script && google.script.url){
          google.script.url.getLocation(loc=>{
            TOKEN = (loc && loc.parameter && loc.parameter.t) ? String(loc.parameter.t) : '';
            UNIT  = (loc && loc.parameter && loc.parameter.unit) ? String(loc.parameter.unit) : '';
            cb();
          });
        }else{
          const p = new URLSearchParams(location.search);
          TOKEN = p.get('t') || '';
          UNIT  = p.get('unit') || '';
          cb();
        }
      }

      function goHome(){
        if (!TOKEN){
          goLogin();
          return;
        }
        const url = EXEC_BASE + '?t=' + encodeURIComponent(TOKEN);
        try{ window.top.location.href = url; }
        catch(_){ window.location.href = url; }
      }

      function goLogin(){
        try{ window.top.location.href = EXEC_BASE; }
        catch(_){ window.location.href = EXEC_BASE; }
      }

      function goStamp(){
        if (!TOKEN){
          alert('ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­ã€‚');
          return;
        }
        const url =
          EXEC_BASE
          + '?page=game_stamp'
          + '&t=' + encodeURIComponent(TOKEN)
          + '&unit=' + encodeURIComponent(UNIT || '');
        try{ window.top.location.href = url; }
        catch(_){ window.location.href = url; }
      }

      function goBoss(){
        if (!TOKEN){
          alert('ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­ã€‚');
          return;
        }
        const url =
          EXEC_BASE
          + '?page=game_boss'
          + '&t=' + encodeURIComponent(TOKEN)
          + '&unit=' + encodeURIComponent(UNIT || '');
        try{ window.top.location.href = url; }
        catch(_){ window.location.href = url; }
      }

      // â˜… ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼ˆstudent_idï¼‰ã§è¡¨ç¤º
      function updateUserLabel(){
        const hasGScript = (typeof google !== 'undefined' && google.script && google.script.run);
        if (!TOKEN || !hasGScript) return;

        google.script.run
          .withSuccessHandler(stu=>{
            if (stu && stu.student_id){
              document.getElementById('userLabel').textContent = `${stu.student_id}ã•ã‚“`;
            }
          })
          .getStudentByToken(TOKEN);
      }

      function updateUnitLabel(){
        const el = document.getElementById('unitLabel');
        if (!UNIT){
          el.textContent = '';
        }else{
          el.textContent = `å¯¾è±¡: Unit ${UNIT}`;
        }
      }

      function updateReviewStates(){
        const stampStateEl = document.getElementById('stampState');
        const bossStateEl  = document.getElementById('bossState');
        const btnBoss      = document.getElementById('btnBoss');

        const hasGScript = (typeof google !== 'undefined' && google.script && google.script.run);

        if (!TOKEN || !hasGScript){
          stampStateEl.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚';
          bossStateEl.textContent  = 'ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ã­ã€‚';
          btnBoss.disabled = true;
          return;
        }

        google.script.run
          .withSuccessHandler(list=>{
            const ids = Array.isArray(list)
              ? list.map(n=>Number(n)).filter(x=>Number.isFinite(x))
              : [];
            const wrongCount = ids.length;

            if (!wrongCount){
              stampStateEl.textContent = 'ä»Šã¯ã¾ã¡ãŒãˆãŸå•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšã¯ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ã§ã‚ãã¼ã†ï¼';
              bossStateEl.textContent  = 'ãƒœã‚¹ã¨ãŸãŸã‹ã†ã«ã¯ã€ã¾ãšã¯ã¾ã¡ãŒãˆãŸå•é¡Œã‚’ã¤ãã‚ã†ã€‚';
              btnBoss.disabled = true;
              return;
            }

            stampStateEl.textContent =
              `ä»Šã¾ã§ã¾ã¡ãŒãˆãŸå•é¡ŒãŒ ${wrongCount} å•ã‚ã‚Šã¾ã™ã€‚ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ã‚ã¤ã‚ã‚ˆã†ï¼`;

            if (wrongCount >= 5){
              bossStateEl.textContent =
                `ãƒœã‚¹è¨ä¼ãŒè§£ç¦ã•ã‚ŒãŸã‚ˆï¼ã¾ã¡ãŒãˆãŸå•é¡Œ ${wrongCount} å•ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã§ 5 å•å‡ºã‚‹ã‚ˆã€‚`;
              btnBoss.disabled = false;
            }else{
              bossStateEl.textContent =
                `ãƒœã‚¹è¨ä¼ã¯ ã¾ã¡ãŒãˆãŸå•é¡ŒãŒ 5 å•ä»¥ä¸Šã§è§£ç¦ã•ã‚Œã¾ã™ã€‚ï¼ˆä»Šã¯ ${wrongCount} å•ï¼‰`;
              btnBoss.disabled = true;
            }
          })
          .withFailureHandler(err=>{
            console.log(err);
            stampStateEl.textContent = 'å¾©ç¿’ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦ã‚‚ã†ä¸€åº¦ãŸã‚ã—ã¦ã­ã€‚';
            bossStateEl.textContent  = 'ãƒœã‚¹è¨ä¼ãƒœã‚¿ãƒ³ã¯ä»Šã¯ã‚ªãƒ•ã«ãªã£ã¦ã„ã¾ã™ã€‚';
            btnBoss.disabled = true;
          })
          // â˜… ã“ã“ã§ã€Œä»Šé–‹ã„ã¦ã„ã‚‹ãƒ¦ãƒ‹ãƒƒãƒˆç•ªå·ã€ã‚’ä¸€ç·’ã«æ¸¡ã™
          .getReviewList(TOKEN, UNIT || '');
      }

      window.addEventListener('load', () => {
        document.getElementById('btnHome').addEventListener('click', goHome);
        document.getElementById('btnLogout').addEventListener('click', goLogin);
        document.getElementById('btnStamp').addEventListener('click', goStamp);
        document.getElementById('btnBoss').addEventListener('click', goBoss);

        resolveTokenAndUnit(()=>{
          updateUserLabel();
          updateUnitLabel();
          updateReviewStates();
        });
      });
    </script>
  </body>
</html>
